<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Overlay (FX × Sentiment × Digest)</title>
  <style>
    :root{
      --bg:#0e1117; --panel:#111827; --panel2:#0b1220; --text:#e5e7eb; --muted:#94a3b8;
      --line:#1f2937; --link:#93c5fd; --btn:#1f2937;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--text)}
    header{position:sticky; top:0; z-index:10; background:rgba(0,0,0,0.7); backdrop-filter: blur(6px); border-bottom:1px solid var(--line)}
    .bar{display:flex; gap:14px; align-items:center; padding:10px 14px}
    .brand{font-weight:700}
    nav a{color:var(--link); text-decoration:none; margin-right:10px; font-size:14px}
    nav a:hover{text-decoration:underline}
    main{padding:18px 14px; max-width:1200px; margin:0 auto}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--line); border-radius:14px; padding:14px; margin-bottom:14px}
    .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:10px; border:1px solid var(--line); background:var(--btn); color:var(--text); cursor:pointer; text-decoration:none; font-size:14px}
    .btn:hover{background:#223049}
    .pill{padding:4px 8px; border-radius:999px; border:1px solid var(--line); font-size:12px; color:var(--muted)}
    .muted{color:var(--muted); font-size:13px}
    iframe{width:100%; border:1px solid var(--line); border-radius:14px; background:#000}
    img{max-width:100%; display:block; border-radius:14px; border:1px solid var(--line); background:#000}
    .path{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:12px; color:var(--muted)}
  </style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand">GenesisPrediction v2</div>
    <nav>
      <a id="navHome" href="/static/index.html">Home</a>
      <a id="navOverlay" href="/static/overlay.html">Overlay</a>
      <a id="navSent" href="/static/sentiment.html">Sentiment</a>
    </nav>
    <div style="margin-left:auto" class="muted">受動ビュー：正本（PNG/CSV/HTML）を読むだけ</div>
  </div>
</header>

<main>
  <div class="card">
    <h1 style="margin:0 0 6px;">Overlay（FX × Sentiment × Digest）</h1>
    <div class="muted">※ 日付は URL <span class="path">?date=YYYY-MM-DD</span> で指定（なければ Sentiment CSV の最新日）</div>

    <div class="row" style="margin-top:10px;">
      <span class="pill">DATE</span>
      <input id="dateInput" type="date" style="padding:7px 10px; border-radius:10px; border:1px solid var(--line); background:#0b1020; color:var(--text)">
      <button class="btn" id="todayBtn">today</button>
      <button class="btn" id="prevBtn">-1d</button>
      <button class="btn" id="nextBtn">+1d</button>
      <button class="btn" id="reloadBtn">reload</button>
      <a class="btn" id="openDigest" href="#" target="_blank" rel="noopener">open digest</a>
      <a class="btn" id="openFX" href="#" target="_blank" rel="noopener">open fx</a>
    </div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 6px;">FX（overlay PNG）</h2>
    <div class="path" id="fxPath">-</div>
    <div style="margin-top:10px;">
      <img id="fxImg" alt="FX overlay">
    </div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 6px;">Sentiment</h2>
    <div class="muted">※ Sentiment ページを埋め込み（CSVはfetchで読込）</div>
    <iframe id="sentFrame" title="Sentiment" style="height:520px; margin-top:10px;"></iframe>
  </div>

  <div class="card">
    <h2 style="margin:0 0 6px;">Digest（HTML）</h2>
    <div class="path" id="digestPath">-</div>
    <iframe id="digestFrame" title="Digest" style="height:760px; margin-top:10px;"></iframe>
  </div>
</main>

<script>
  function qs(name){ return new URLSearchParams(location.search).get(name); }
  function setHref(id, url){ const el=document.getElementById(id); if(el) el.href=url; }
  async function fetchText(url){
    const r = await fetch(url, {cache:"no-store"});
    if(!r.ok) throw new Error("HTTP " + r.status + " " + url);
    return await r.text();
  }
  function parseCSV(text){
    const lines = text.trim().split(/\r?\n/);
    if(lines.length < 2) return [];
    const headers = lines[0].split(",").map(s=>s.trim());
    const rows = [];
    for(let i=1;i<lines.length;i++){
      const cols = lines[i].split(",");
      const obj = {};
      headers.forEach((h, idx)=> obj[h] = (cols[idx] ?? "").trim());
      rows.push(obj);
    }
    return rows;
  }
  function addDays(yyyy_mm_dd, delta){
    const [y,m,d] = yyyy_mm_dd.split("-").map(Number);
    const dt = new Date(Date.UTC(y, m-1, d));
    dt.setUTCDate(dt.getUTCDate()+delta);
    const yy = dt.getUTCFullYear();
    const mm = String(dt.getUTCMonth()+1).padStart(2,"0");
    const dd = String(dt.getUTCDate()).padStart(2,"0");
    return `${yy}-${mm}-${dd}`;
  }
  async function pickFirstExists(urls){
    for (const u of urls){
      try{
        const r = await fetch(u, {method:"HEAD", cache:"no-store"});
        if(r.ok) return u;
      }catch(e){}
    }
    return urls[urls.length-1];
  }

  (async ()=>{
    const csvUrl = "/analysis/sentiment_timeseries.csv";
    let date = qs("date");

    // if date not given, infer from last row of sentiment csv
    if(!date){
      try{
        const csv = await fetchText(csvUrl + "?t=" + Date.now());
        const rows = parseCSV(csv);
        if(rows.length) date = rows[rows.length-1].date;
      }catch(e){}
    }
    if(!date){
      // hard fallback
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth()+1).padStart(2,"0");
      const d = String(now.getDate()).padStart(2,"0");
      date = `${y}-${m}-${d}`;
    }

    const dateInput = document.getElementById("dateInput");
    dateInput.value = date;

    const apply = async (d)=>{
      // update nav links with date
      setHref("navHome", "/static/index.html?date=" + encodeURIComponent(d));
      setHref("navOverlay", "/static/overlay.html?date=" + encodeURIComponent(d));
      setHref("navSent", "/static/sentiment.html?date=" + encodeURIComponent(d));

      // digest
      const digestUrl = "/analysis/daily_news_" + d + ".html";
      document.getElementById("digestPath").textContent = digestUrl;
      document.getElementById("digestFrame").src = digestUrl;
      setHref("openDigest", digestUrl);

      // fx (prefer dated)
      const fxCandidates = [
        "/analysis/fx_overlay_" + d + ".png",
        "/analysis/jpy_thb_remittance_overlay.png"
      ];
      const fxUrl = await pickFirstExists(fxCandidates);
      document.getElementById("fxPath").textContent = fxUrl;
      document.getElementById("fxImg").src = fxUrl + "?t=" + Date.now();
      setHref("openFX", fxUrl);

      // sentiment (embed page)
      document.getElementById("sentFrame").src = "/static/sentiment.html?date=" + encodeURIComponent(d);
    };

    await apply(date);

    // buttons
    document.getElementById("reloadBtn").addEventListener("click", ()=> apply(dateInput.value));
    document.getElementById("prevBtn").addEventListener("click", ()=>{
      const d = addDays(dateInput.value, -1);
      dateInput.value = d;
      apply(d);
      history.replaceState(null,"", "/static/overlay.html?date=" + encodeURIComponent(d));
    });
    document.getElementById("nextBtn").addEventListener("click", ()=>{
      const d = addDays(dateInput.value, +1);
      dateInput.value = d;
      apply(d);
      history.replaceState(null,"", "/static/overlay.html?date=" + encodeURIComponent(d));
    });
    document.getElementById("todayBtn").addEventListener("click", ()=>{
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth()+1).padStart(2,"0");
      const dd = String(now.getDate()).padStart(2,"0");
      const d = `${y}-${m}-${dd}`;
      dateInput.value = d;
      apply(d);
      history.replaceState(null,"", "/static/overlay.html?date=" + encodeURIComponent(d));
    });

    // change date manually
    dateInput.addEventListener("change", ()=>{
      const d = dateInput.value;
      apply(d);
      history.replaceState(null,"", "/static/overlay.html?date=" + encodeURIComponent(d));
    });
  })();
</script>
</body>
</html>
