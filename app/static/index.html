<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GenesisPrediction v2 - Local GUI</title>
  <style>
    :root{
      --bg:#ffffff; --text:#111827; --muted:#6b7280; --card:#ffffff; --border:#e5e7eb;
      --shadow:0 1px 2px rgba(0,0,0,.06), 0 8px 24px rgba(0,0,0,.06);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    body{ margin:0; padding:32px; font-family:var(--sans); color:var(--text); background:var(--bg); }
    h1{ font-size:44px; margin:0 0 6px 0; letter-spacing:-.02em; }
    .subtitle{ color:var(--muted); margin-bottom:22px; }
    .grid{ display:grid; grid-template-columns: 1fr; gap:22px; }
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:20px;
    }
    .card h2{ margin:0 0 6px 0; font-size:28px; letter-spacing:-.01em; }
    .muted{ color:var(--muted); }
    .row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .pill{ border:1px solid var(--border); border-radius:999px; padding:4px 10px; font-weight:700; }
    button{
      border:1px solid var(--border); background:#fff; border-radius:12px;
      padding:10px 14px; cursor:pointer; font-weight:700;
      box-shadow:0 1px 1px rgba(0,0,0,.03);
    }
    button:hover{ background:#f9fafb; }
    .kv{ display:grid; grid-template-columns: 220px 1fr; gap:8px 14px; margin-top:12px; }
    .kv div{ padding:2px 0; }
    .sep{ height:1px; background:var(--border); margin:14px 0; }
    .mono{
      font-family:var(--mono);
      font-size:12px; line-height:1.45;
      background:#0b1020; color:#e5e7eb;
      padding:12px; border-radius:14px; overflow:auto; max-height:340px;
      border:1px solid rgba(255,255,255,.06);
    }
    select, input{
      border:1px solid var(--border); border-radius:10px; padding:8px 10px; font-weight:600;
      background:#fff;
    }
  </style>
</head>
<body>
  <h1>GenesisPrediction v2 - Local GUI</h1>
  <div class="subtitle">World politics outputs + FX remittance decision (JPY→THB).</div>

  <div class="grid">
    <!-- FX -->
    <div class="card">
      <h2>FX Remittance (JPY→THB)</h2>

      <div class="row" style="margin-top:8px;">
        <div class="muted">Today:</div>
        <div id="fxTodayDate" class="pill">-</div>
        <div id="fxTodayDecision" class="pill">-</div>
        <button id="btnFxRefresh">Refresh</button>
      </div>

      <div class="kv">
        <div class="muted">combined_noise</div><div id="fxCombined">-</div>
        <div class="muted">USDJPY / USDTHB</div><div id="fxPairNoise">-</div>
        <div class="muted">recommended_action</div><div id="fxAction">-</div>
        <div class="muted">note</div><div id="fxNote">-</div>
      </div>

      <div class="sep"></div>

      <div class="row">
        <div class="muted">Monthly:</div>
        <select id="fxMonth"></select>
        <button id="btnFxMonthly">Load</button>
      </div>

      <div class="kv">
        <div class="muted">days</div><div id="fxDays">-</div>
        <div class="muted">avg_noise</div><div id="fxAvgNoise">-</div>
        <div class="muted">counts</div><div id="fxCounts">-</div>
        <div class="muted">actions</div><div id="fxActions">-</div>
      </div>

      <div class="muted" style="margin-top:10px;">
        Reports directory: <span id="fxReportsDir">-</span>
      </div>
    </div>

    <!-- World Politics -->
    <div class="card">
      <h2>World Politics</h2>
      <div class="muted">Outputs list + Digest generation &amp; viewing.</div>

      <div class="row" style="margin-top:10px;">
        <button id="btnOutputsToday">Load outputs (today)</button>
        <button id="btnRunDigest">Run digest (today)</button>
        <button id="btnOpenDigest">Open digest HTML (today)</button>
      </div>

      <div class="sep"></div>

      <div id="wpOut" class="mono">Press buttons above…</div>
    </div>
  </div>

<script>
  const todayISO = () => new Date().toISOString().slice(0,10);
  const ymISO = (d) => d.toISOString().slice(0,7);

  function fmt(x){
    if (x === null || x === undefined) return "-";
    if (typeof x === "number" && !Number.isInteger(x)) return x.toFixed(3);
    return String(x);
  }

  async function jget(url){
    const r = await fetch(url);
    const t = await r.text();
    try { return { ok:r.ok, status:r.status, data: JSON.parse(t) }; }
    catch { return { ok:r.ok, status:r.status, data: t }; }
  }

  function setMono(obj){
    const el = document.getElementById("wpOut");
    el.textContent = (typeof obj === "string") ? obj : JSON.stringify(obj, null, 2);
  }

  // FX
  async function loadFxToday(){
    const d = todayISO();
    const res = await jget(`/api/fx/remittance/today?date=${encodeURIComponent(d)}`);
    if (!res.ok){
      document.getElementById("fxTodayDate").textContent = d;
      document.getElementById("fxTodayDecision").textContent = "N/A";
      document.getElementById("fxCombined").textContent = "-";
      document.getElementById("fxPairNoise").textContent = "-";
      document.getElementById("fxAction").textContent = "-";
      document.getElementById("fxNote").textContent = "not found";
      document.getElementById("fxReportsDir").textContent = (res.data && res.data.path) ? res.data.path : "-";
      return;
    }
    const x = res.data;
    document.getElementById("fxTodayDate").textContent = x.date || d;
    document.getElementById("fxTodayDecision").textContent = (x.decision || "-");
    document.getElementById("fxCombined").textContent = fmt(x.combined_noise_prob);
    document.getElementById("fxPairNoise").textContent = `${fmt(x.usd_jpy_noise)} / ${fmt(x.usd_thb_noise)}`;
    document.getElementById("fxAction").textContent = (x.recommended_action || "-");
    document.getElementById("fxNote").textContent = (x.remit_note || "-");
    document.getElementById("fxReportsDir").textContent = (x.reports_dir || "-");
  }

  async function loadFxMonthly(){
    const m = document.getElementById("fxMonth").value;
    const res = await jget(`/api/fx/remittance/monthly?month=${encodeURIComponent(m)}`);
    if (!res.ok){
      document.getElementById("fxDays").textContent = "-";
      document.getElementById("fxAvgNoise").textContent = "-";
      document.getElementById("fxCounts").textContent = "not found";
      document.getElementById("fxActions").textContent = "-";
      return;
    }
    const x = res.data;
    document.getElementById("fxDays").textContent = fmt(x.days);
    document.getElementById("fxAvgNoise").textContent = fmt(x.avg_noise);
    document.getElementById("fxCounts").textContent = Object.entries(x.counts || {}).map(([k,v])=>`${k}=${v}`).join(" / ");
    document.getElementById("fxActions").textContent = Object.entries(x.actions || {}).map(([k,v])=>`${k}: ${v}`).join(" | ");
    document.getElementById("fxReportsDir").textContent = (x.reports_dir || "-");
  }

  // World Politics
  async function loadOutputsToday(){
    const d = todayISO();
    const res = await jget(`/api/outputs?date=${encodeURIComponent(d)}`);
    setMono(res.data);
  }

  async function runDigestToday(){
    const d = todayISO();
    setMono({running:true, mode:"digest", date:d});
    const r = await fetch(`/api/run/digest?date=${encodeURIComponent(d)}&limit=40`, { method:"POST" });
    const t = await r.text();
    try { setMono(JSON.parse(t)); }
    catch { setMono(t); }
  }

  function openDigestToday(){
    const d = todayISO();
    window.open(`/api/digest/html?date=${encodeURIComponent(d)}`, "_blank");
  }

  // init month selector (last 12 months)
  (function initMonths(){
    const sel = document.getElementById("fxMonth");
    const now = new Date();
    for (let i=0;i<12;i++){
      const dd = new Date(now.getFullYear(), now.getMonth()-i, 1);
      const v = ymISO(dd);
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      sel.appendChild(opt);
    }
  })();

  document.getElementById("btnFxRefresh").addEventListener("click", loadFxToday);
  document.getElementById("btnFxMonthly").addEventListener("click", loadFxMonthly);
  document.getElementById("btnOutputsToday").addEventListener("click", loadOutputsToday);
  document.getElementById("btnRunDigest").addEventListener("click", runDigestToday);
  document.getElementById("btnOpenDigest").addEventListener("click", openDigestToday);

  // auto
  loadFxToday().catch(()=>{});
  loadFxMonthly().catch(()=>{});
</script>
</body>
</html>
