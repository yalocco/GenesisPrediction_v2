<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GenesisPrediction v2 - Home</title>
  <style>
    :root{
      --bg:#0e1117; --panel:#111827; --panel2:#0b1220; --text:#e5e7eb; --muted:#94a3b8;
      --line:#1f2937; --link:#93c5fd; --btn:#1f2937; --btn2:#0b1220; --ok:#10b981;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--text)}
    header{position:sticky; top:0; z-index:10; background:rgba(0,0,0,0.7); backdrop-filter: blur(6px); border-bottom:1px solid var(--line)}
    .bar{display:flex; gap:14px; align-items:center; padding:10px 14px}
    .brand{font-weight:700}
    nav a{color:var(--link); text-decoration:none; margin-right:10px; font-size:14px}
    nav a:hover{text-decoration:underline}
    main{padding:18px 14px; max-width:1200px; margin:0 auto}
    .grid{display:grid; gap:14px}
    @media(min-width:980px){ .grid{grid-template-columns: 1.2fr 0.8fr;} }
    .card{background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--line); border-radius:14px; padding:14px}
    .title{font-size:18px; font-weight:700; margin:0 0 8px}
    .muted{color:var(--muted); font-size:13px}
    .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:10px; border:1px solid var(--line); background:var(--btn); color:var(--text); cursor:pointer; text-decoration:none; font-size:14px}
    .btn:hover{background:#223049}
    .btn:disabled{opacity:0.45; cursor:not-allowed}
    .pill{padding:4px 8px; border-radius:999px; border:1px solid var(--line); font-size:12px; color:var(--muted)}
    .kpi{display:grid; grid-template-columns: 110px 1fr; gap:6px 10px; margin-top:10px; font-size:14px}
    .kpi div{padding:3px 0}
    .kpi .k{color:var(--muted)}
    .previewWrap{border:1px solid var(--line); border-radius:14px; overflow:hidden; background:#000}
    iframe{width:100%; border:0}
    img{max-width:100%; display:block; border-radius:12px; border:1px solid var(--line); background:#000}
    .hr{height:1px; background:var(--line); margin:12px 0}
    .small{font-size:12px}
    .okdot{display:inline-block; width:10px; height:10px; border-radius:50%; background:var(--ok); margin-right:6px}
  </style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand">GenesisPrediction v2</div>
    <nav>
      <a href="/static/index.html">Home</a>
      <a id="navOverlay" href="/static/overlay.html">Overlay</a>
      <a id="navSent" href="/static/sentiment.html">Sentiment</a>
    </nav>
    <div style="margin-left:auto" class="muted small">
      <span class="okdot"></span>GUI is read-only (SST)
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <!-- Left -->
    <div class="card">
      <h2 class="title">Today / Latest</h2>
      <div class="muted">正本（PNG/CSV/HTML）を読むだけ。GUIは再計算しません。</div>

      <div class="row" style="margin-top:10px;">
        <span class="pill">date: <span id="dateLabel">loading…</span></span>
        <a class="btn" id="openOverlayBtn" href="/static/overlay.html">Open Overlay</a>
        <a class="btn" id="openSentBtn" href="/static/sentiment.html">Open Sentiment</a>
        <a class="btn" id="openDigestBtn" href="#" target="_blank" rel="noopener">Open Digest HTML</a>
      </div>

      <div class="kpi" id="kpi">
        <div class="k">sentiment articles</div><div id="k_articles">-</div>
        <div class="k">risk</div><div id="k_risk">-</div>
        <div class="k">positive</div><div id="k_pos">-</div>
        <div class="k">uncertainty</div><div id="k_unc">-</div>
      </div>

      <div class="hr"></div>

      <h3 class="title" style="font-size:16px;">Digest preview</h3>
      <div class="muted small">※ HTMLをそのまま埋め込み表示（パースしない）。</div>
      <div class="previewWrap" style="margin-top:10px;">
        <iframe id="digestFrame" title="Digest preview" style="height:680px;"></iframe>
      </div>
    </div>

    <!-- Right -->
    <div class="card">
      <h2 class="title">Run (CLI only)</h2>
      <div class="muted">日次生成は CLI/PowerShell で実行してください。</div>

      <div class="row" style="margin-top:10px;">
        <button class="btn" disabled title="GUIから実行しません">Run Daily (disabled)</button>
      </div>

      <pre style="margin-top:10px; padding:10px; border:1px solid var(--line); border-radius:12px; background:#0b1020; color:#cbd5e1; overflow:auto;">
docker compose run --rm analyzer
# または
scripts/run_daily.ps1
      </pre>

      <div class="hr"></div>

      <h3 class="title" style="font-size:16px;">FX preview</h3>
      <div class="muted small">dated があれば dated を優先。なければ latest にフォールバック。</div>
      <div style="margin-top:10px;">
        <div class="muted small" id="fxPathLabel">-</div>
        <a id="fxOpenLink" class="btn" href="#" target="_blank" rel="noopener" style="margin:10px 0 8px;">open image</a>
        <img id="fxImg" alt="FX overlay preview" />
      </div>
    </div>
  </div>
</main>

<script>
  // ---------- helpers ----------
  function qs(name){ return new URLSearchParams(location.search).get(name); }
  function setHref(id, url){ const el=document.getElementById(id); if(el) el.href=url; }
  function fmt(n){
    const x = Number(n);
    if (!isFinite(x)) return String(n ?? "-");
    return x.toFixed(6);
  }
  async function fetchText(url){
    const r = await fetch(url, {cache:"no-store"});
    if(!r.ok) throw new Error("HTTP " + r.status + " " + url);
    return await r.text();
  }
  function parseCSV(text){
    const lines = text.trim().split(/\r?\n/);
    if(lines.length < 2) return [];
    const headers = lines[0].split(",").map(s=>s.trim());
    const rows = [];
    for(let i=1;i<lines.length;i++){
      const cols = lines[i].split(",");
      const obj = {};
      headers.forEach((h, idx)=> obj[h] = (cols[idx] ?? "").trim());
      rows.push(obj);
    }
    return rows;
  }
  async function pickFirstExists(urls){
    for (const u of urls){
      try{
        const r = await fetch(u, {method:"HEAD", cache:"no-store"});
        if(r.ok) return u;
      }catch(e){}
    }
    return urls[urls.length-1];
  }

  // ---------- main ----------
  (async ()=>{
    // latest date from sentiment_timeseries.csv
    const csvUrl = "/analysis/sentiment_timeseries.csv";
    let latestDate = qs("date") || null;

    try{
      const csv = await fetchText(csvUrl + "?t=" + Date.now());
      const rows = parseCSV(csv);
      if(rows.length){
        const last = rows[rows.length-1];
        latestDate = latestDate || last.date || latestDate;

        document.getElementById("k_articles").textContent = last.articles ?? "-";
        document.getElementById("k_risk").textContent = fmt(last.risk);
        document.getElementById("k_pos").textContent = fmt(last.positive ?? last.pos);
        document.getElementById("k_unc").textContent = fmt(last.uncertainty ?? last.unc);
        document.getElementById("dateLabel").textContent = latestDate ?? "unknown";
      } else {
        document.getElementById("dateLabel").textContent = latestDate ?? "unknown";
      }
    }catch(e){
      document.getElementById("dateLabel").textContent = latestDate ?? "unknown";
    }

    // nav links with date
    const d = latestDate;
    if(d){
      setHref("navOverlay", "/static/overlay.html?date=" + encodeURIComponent(d));
      setHref("openOverlayBtn", "/static/overlay.html?date=" + encodeURIComponent(d));
      setHref("navSent", "/static/sentiment.html?date=" + encodeURIComponent(d));
      setHref("openSentBtn", "/static/sentiment.html?date=" + encodeURIComponent(d));

      const digestUrl = "/analysis/daily_news_" + d + ".html";
      setHref("openDigestBtn", digestUrl);
      document.getElementById("digestFrame").src = digestUrl;

      // FX: prefer dated, fallback to latest
      const fxCandidates = [
        "/analysis/fx_overlay_" + d + ".png",
        "/analysis/jpy_thb_remittance_overlay.png"
      ];
      const picked = await pickFirstExists(fxCandidates);
      document.getElementById("fxPathLabel").textContent = picked;
      document.getElementById("fxOpenLink").href = picked;
      document.getElementById("fxImg").src = picked + "?t=" + Date.now();
    }else{
      // fallback
      const fallback = "/analysis/jpy_thb_remittance_overlay.png";
      document.getElementById("fxPathLabel").textContent = fallback;
      document.getElementById("fxOpenLink").href = fallback;
      document.getElementById("fxImg").src = fallback + "?t=" + Date.now();
    }
  })();
</script>
</body>
</html>
