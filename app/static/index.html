<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GenesisPrediction v2 - Local GUI</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background:#fff; color:#111; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 28px 22px 60px; }
    h1 { font-size: 44px; letter-spacing: -0.02em; margin: 10px 0 6px; }
    .sub { color:#555; margin: 0 0 22px; }
    .card { border: 1px solid #e6e6e6; border-radius: 16px; padding: 18px 18px; margin: 18px 0; background: #fff; }
    .card h2 { margin: 0 0 12px; font-size: 28px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .kv { display:grid; grid-template-columns: 220px 1fr; gap: 8px 14px; margin: 10px 0 0; }
    .k { color:#666; }
    .v { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space: pre-wrap; }
    button, .btnlink {
      border: 1px solid #d5d5d5;
      background: #fff;
      border-radius: 12px;
      padding: 8px 12px;
      cursor: pointer;
      font-weight: 600;
      text-decoration: none;
      color: #111;
      display: inline-block;
    }
    button:hover, .btnlink:hover { background:#f7f7f7; }
    select, input { border: 1px solid #d5d5d5; border-radius: 10px; padding: 7px 10px; }
    .muted { color:#777; font-size: 13px; }
    .log { margin-top: 14px; border-radius: 12px; background:#0b0b0b; color:#eaeaea; padding: 12px; font-family: ui-monospace, Menlo, Consolas, monospace; font-size: 12px; min-height: 44px; }
    .badge { display:inline-block; padding: 6px 10px; border:1px solid #e0e0e0; border-radius: 999px; font-weight: 700; background:#fafafa; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>GenesisPrediction v2 - Local GUI</h1>
    <p class="sub">World politics outputs + FX remittance decision (JPY→THB).</p>

    <div class="card">
      <h2>FX Remittance (JPY→THB)</h2>
      <div class="row">
        <div class="muted">Today:</div>
        <div class="badge" id="fxToday">-</div>
        <div class="badge" id="fxDecision">-</div>
        <button id="fxRefresh">Refresh</button>
      </div>

      <div class="kv" style="margin-top:14px">
        <div class="k">combined_noise</div><div class="v" id="fxNoise">-</div>
        <div class="k">USDJPY / USDTHB</div><div class="v" id="fxPair">-</div>
        <div class="k">recommended_action</div><div class="v" id="fxAction">-</div>
        <div class="k">note</div><div class="v" id="fxNote">-</div>
      </div>

      <hr style="border:none;border-top:1px solid #eee;margin:16px 0" />

      <div class="row">
        <div class="muted">Monthly:</div>
        <select id="fxMonth"></select>
        <button id="fxLoadMonth">Load</button>
      </div>

      <div class="kv" style="margin-top:14px">
        <div class="k">days</div><div class="v" id="fxMDays">-</div>
        <div class="k">avg_noise</div><div class="v" id="fxMAvg">-</div>
        <div class="k">counts</div><div class="v" id="fxMCounts">-</div>
        <div class="k">actions</div><div class="v" id="fxMActions">-</div>
      </div>

      <p class="muted" style="margin:10px 0 0">Reports directory: <span class="v">data/fx/reports</span></p>
    </div>

    <div class="card">
      <h2>World Politics</h2>
      <p class="muted">Outputs list + Digest generation & viewing.</p>

      <div class="row">
        <button id="wpLoad">Load outputs (today)</button>
        <button id="wpRunDigest">Run digest (today)</button>

        <!-- Option 2: Link (preferred) -->
        <a class="btnlink" id="wpOpenDigestHtml" href="#" target="_blank" rel="noopener">Open digest HTML (today)</a>
        <a class="btnlink" id="wpOpenDigestMd" href="#" target="_blank" rel="noopener">Open digest MD (today)</a>
      </div>

      <div class="log" id="wpLog">Press buttons above…</div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  function todayISO() {
    const d = new Date();
    const pad = (n) => String(n).padStart(2, "0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }

  function setDigestLinks(dateStr) {
    $("wpOpenDigestHtml").href = `/api/digest/html?date=${encodeURIComponent(dateStr)}`;
    $("wpOpenDigestMd").href   = `/api/digest/md_view?date=${encodeURIComponent(dateStr)}`;
  }

  async function apiGet(url) {
    const r = await fetch(url);
    let body;
    const ct = r.headers.get("content-type") || "";
    if (ct.includes("application/json")) body = await r.json();
    else body = await r.text();
    return { ok: r.ok, status: r.status, body };
  }

  async function apiPost(url) {
    const r = await fetch(url, { method: "POST" });
    const ct = r.headers.get("content-type") || "";
    const body = ct.includes("application/json") ? await r.json() : await r.text();
    return { ok: r.ok, status: r.status, body };
  }

  function log(msg) {
    $("wpLog").textContent = msg;
  }

  function initMonths() {
    const d = new Date();
    const y = d.getFullYear();
    const m = d.getMonth()+1;
    const months = [];
    for (let i=0; i<14; i++) {
      const mm = m - i;
      const yy = y + Math.floor((mm-1)/12);
      const m2 = ((mm-1)%12+12)%12 + 1;
      const pad = (n) => String(n).padStart(2,"0");
      months.push(`${yy}-${pad(m2)}`);
    }
    $("fxMonth").innerHTML = months.map(x => `<option value="${x}">${x}</option>`).join("");
  }

  async function refreshFxToday() {
    const { ok, body } = await apiGet("/api/fx/remittance/today");
    if (!ok) {
      $("fxToday").textContent = todayISO();
      $("fxDecision").textContent = "N/A";
      $("fxNoise").textContent = "-";
      $("fxPair").textContent = "-";
      $("fxAction").textContent = "-";
      $("fxNote").textContent = body?.error || "error";
      return;
    }
    const row = body.row || {};
    $("fxToday").textContent = row.date || todayISO();
    $("fxDecision").textContent = row.decision || "-";
    $("fxNoise").textContent = row.combined_noise_prob || row.combined_noise || "-";
    const uj = row.usdjpy || row.USDJPY || "-";
    const ut = row.usdthb || row.USDTHB || "-";
    $("fxPair").textContent = `${uj} / ${ut}`;
    $("fxAction").textContent = row.recommended_action || row.action || "-";
    $("fxNote").textContent = row.note || row.remit_note || "-";
  }

  async function loadFxMonth() {
    const month = $("fxMonth").value;
    const { ok, body } = await apiGet(`/api/fx/remittance/month?month=${encodeURIComponent(month)}`);
    if (!ok) {
      $("fxMDays").textContent = "-";
      $("fxMAvg").textContent = "-";
      $("fxMCounts").textContent = "-";
      $("fxMActions").textContent = body?.error || "error";
      return;
    }
    const rows = body.rows || [];
    $("fxMDays").textContent = rows.length;

    // best-effort stats
    let sum = 0, cnt = 0;
    const counts = {};
    const actions = {};
    for (const r of rows) {
      const n = parseFloat(r.combined_noise_prob || r.combined_noise || "");
      if (!Number.isNaN(n)) { sum += n; cnt++; }
      counts[r.decision || "UNK"] = (counts[r.decision || "UNK"] || 0) + 1;
      actions[r.recommended_action || r.action || "UNK"] = (actions[r.recommended_action || r.action || "UNK"] || 0) + 1;
    }
    $("fxMAvg").textContent = (cnt ? (sum/cnt).toFixed(3) : "-");
    $("fxMCounts").textContent = Object.entries(counts).map(([k,v])=>`${k}=${v}`).join(" / ") || "-";
    $("fxMActions").textContent = Object.entries(actions).map(([k,v])=>`${k}: ${v}`).join(" | ") || "-";
  }

  async function wpLoadOutputsToday() {
    const d = todayISO();
    setDigestLinks(d);
    const { ok, body } = await apiGet(`/api/world/analysis/files?date=${encodeURIComponent(d)}`);
    if (!ok) return log(typeof body === "string" ? body : JSON.stringify(body, null, 2));
    log(JSON.stringify(body, null, 2));
  }

  async function wpRunDigestToday() {
    const d = todayISO();
    setDigestLinks(d);
    log("Running digest…");
    const { ok, body } = await apiPost(`/api/run/digest?date=${encodeURIComponent(d)}&limit=40`);
    if (!ok) return log(typeof body === "string" ? body : JSON.stringify(body, null, 2));
    log(JSON.stringify(body, null, 2));
  }

  // Wire up
  initMonths();
  setDigestLinks(todayISO());

  $("fxRefresh").addEventListener("click", refreshFxToday);
  $("fxLoadMonth").addEventListener("click", loadFxMonth);

  $("wpLoad").addEventListener("click", wpLoadOutputsToday);
  $("wpRunDigest").addEventListener("click", wpRunDigestToday);

  // Initial load
  refreshFxToday();
  loadFxMonth();
</script>
</body>
</html>
