<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sentiment</title>
  <link rel="stylesheet" href="/static/app.css" />
  <style>
    /* 保険：app.css が想定外でも最低限崩れない */
    .page { padding: 16px; }
    .topbar { padding: 12px 16px; }
    .topbar-inner { display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap; }
    .topbar-title { font-size: 28px; font-weight: 700; }
    .topbar-nav a { margin-right: 10px; text-decoration:none; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 14px; }
    .card { border-radius: 14px; padding: 14px; }
    .muted { opacity: .75; }
    .articles { margin-top: 12px; }
    .row { display:flex; gap:12px; align-items:flex-start; padding: 10px 0; border-top: 1px solid rgba(255,255,255,.08); }
    .row:first-child { border-top: 0; }
    .thumbBox { width: 56px; height: 40px; flex: 0 0 56px; display:flex; align-items:center; justify-content:center; overflow:hidden; border-radius: 10px; background: rgba(255,255,255,.06); }
    .thumbBox img { width:100%; height:100%; object-fit: cover; display:block; }
    .thumbBox .noimg { font-size: 12px; opacity:.6; }
    .title { font-weight: 700; line-height: 1.3; }
    .meta { font-size: 12px; opacity:.75; margin-top: 4px; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; margin-left: 8px; background: rgba(255,255,255,.08); }
    .kpi { display:flex; gap:12px; flex-wrap:wrap; margin-top: 10px; }
    .kpi .box { padding: 10px 12px; border-radius: 12px; background: rgba(255,255,255,.06); }
    .kpi .num { font-size: 22px; font-weight: 800; }
    .kpi .lbl { font-size: 12px; opacity: .75; margin-top: 2px; }
    .err { padding: 10px 12px; border-radius: 12px; background: rgba(255,80,80,.10); }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="topbar-title">Sentiment</div>
      <nav class="topbar-nav" aria-label="Primary">
        <a href="/static/index.html">Index</a>
        <a href="/static/overlay.html">Overlay</a>
        <a href="/static/sentiment.html" aria-current="page">Sentiment</a>
      </nav>
    </div>
  </header>

  <main class="page">
    <section class="card">
      <div class="muted">Latest sentiment / articles</div>

      <div id="status" class="muted" style="margin-top:8px;">loading...</div>

      <div class="kpi" id="kpi" style="display:none;">
        <div class="box"><div class="num" id="kpiArticles">-</div><div class="lbl">Articles</div></div>
        <div class="box"><div class="num" id="kpiNet">-</div><div class="lbl">Net</div></div>
        <div class="box"><div class="num" id="kpiRisk">-</div><div class="lbl">Risk</div></div>
        <div class="box"><div class="num" id="kpiPos">-</div><div class="lbl">Positive</div></div>
        <div class="box"><div class="num" id="kpiUnc">-</div><div class="lbl">Uncertainty</div></div>
      </div>

      <div class="articles" id="articles"></div>
    </section>
  </main>

  <script>
    // ----------------------------
    // Helpers
    // ----------------------------
    function fmtNum(x, digits=3){
      if (x === null || x === undefined || Number.isNaN(Number(x))) return "-";
      return Number(x).toFixed(digits);
    }

    function domainFromUrl(u){
      try { return (new URL(u)).hostname; } catch(e){ return ""; }
    }
    function faviconUrlFor(articleUrl){
      const d = domainFromUrl(articleUrl);
      if(!d) return "";
      // no local save, always online
      return `https://www.google.com/s2/favicons?domain=${encodeURIComponent(d)}&sz=64`;
    }

    // Candidate keys commonly used across pipelines
    function pickImageUrl(item){
      const keys = ["image", "urlToImage", "thumbnail", "thumb", "image_url", "imageUrl", "og_image"];
      for (const k of keys){
        const v = item && item[k];
        if (typeof v === "string" && v.trim().startsWith("http")) return v.trim();
      }
      return "";
    }

    function safeText(s){
      return (s === null || s === undefined) ? "" : String(s);
    }

    // ----------------------------
    // Rendering
    // ----------------------------
    function renderKpi(vm){
      const a = (vm && vm.articles) ? vm.articles : [];
      document.getElementById("kpiArticles").textContent = a.length;

      // try multiple possible locations
      const overall = vm.overall || vm.summary || vm.sentiment || {};
      const net = overall.net ?? vm.net ?? null;
      const risk = overall.risk ?? vm.risk ?? null;
      const pos = overall.pos ?? overall.positive ?? vm.pos ?? vm.positive ?? null;
      const unc = overall.unc ?? overall.uncertainty ?? vm.unc ?? vm.uncertainty ?? null;

      document.getElementById("kpiNet").textContent  = fmtNum(net);
      document.getElementById("kpiRisk").textContent = fmtNum(risk);
      document.getElementById("kpiPos").textContent  = fmtNum(pos);
      document.getElementById("kpiUnc").textContent  = fmtNum(unc);

      document.getElementById("kpi").style.display = "flex";
    }

    function renderArticles(vm){
      const host = document.getElementById("articles");
      host.innerHTML = "";

      const items = (vm && vm.articles) ? vm.articles : (vm && vm.items) ? vm.items : [];
      if (!items || items.length === 0){
        host.innerHTML = `<div class="muted">no articles</div>`;
        return;
      }

      for (const it of items){
        const url = safeText(it.url || it.link || "");
        const title = safeText(it.title || it.headline || "(no title)");
        const source = safeText(it.source || it.site || domainFromUrl(url));
        const published = safeText(it.publishedAt || it.published_at || it.date || "");

        const imgUrl = pickImageUrl(it);
        const fallback = faviconUrlFor(url);

        const row = document.createElement("div");
        row.className = "row";

        const thumb = document.createElement("div");
        thumb.className = "thumbBox";

        if (imgUrl || fallback){
          const im = document.createElement("img");
          im.loading = "lazy";
          im.decoding = "async";
          im.referrerPolicy = "no-referrer"; // hotlink mitigation
          im.src = imgUrl || fallback;

          // if external hotlink is rejected, fallback to favicon; if that fails, show "no image"
          im.onerror = () => {
            if (im.src !== fallback && fallback){
              im.src = fallback;
              return;
            }
            im.remove();
            const no = document.createElement("div");
            no.className = "noimg";
            no.textContent = "no image";
            thumb.appendChild(no);
          };
          thumb.appendChild(im);
        } else {
          const no = document.createElement("div");
          no.className = "noimg";
          no.textContent = "no image";
          thumb.appendChild(no);
        }

        const body = document.createElement("div");
        body.style.flex = "1";

        const a = document.createElement("a");
        a.className = "title";
        a.href = url || "#";
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.textContent = title;

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = [source, published].filter(Boolean).join(" · ");

        // optional score pill (if exists)
        const net = (it.net !== undefined) ? it.net : (it.sentiment_net !== undefined) ? it.sentiment_net : null;
        if (net !== null && net !== undefined && !Number.isNaN(Number(net))){
          const pill = document.createElement("span");
          pill.className = "pill";
          pill.textContent = `net ${fmtNum(net)}`;
          a.appendChild(pill);
        }

        body.appendChild(a);
        body.appendChild(meta);

        row.appendChild(thumb);
        row.appendChild(body);
        host.appendChild(row);
      }
    }

    // ----------------------------
    // Data loading
    // Priority:
    //  1) view_model_latest.json  (if it contains articles)
    //  2) sentiment_latest.json   (fallback)
    // ----------------------------
    async function fetchJson(url){
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error(`${r.status} ${r.statusText} for ${url}`);
      return await r.json();
    }

    async function main(){
      const status = document.getElementById("status");
      try{
        // try view_model first
        let vm = null;
        try{
          vm = await fetchJson("/analysis/view_model_latest.json?v=" + Date.now());
        }catch(e){
          vm = null;
        }

        if (!vm || !(vm.articles && vm.articles.length)){
          // fallback to sentiment
          vm = await fetchJson("/analysis/sentiment_latest.json?v=" + Date.now());
        }

        status.textContent = "OK";
        renderKpi(vm);
        renderArticles(vm);

      }catch(err){
        status.innerHTML = `<div class="err">load failed: ${safeText(err.message || err)}</div>`;
      }
    }

    main();
  </script>
</body>
</html>
