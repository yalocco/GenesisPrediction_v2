<!-- app/static/sentiment.html -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sentiment</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f1833;
      --panel2:#0f1730;
      --line:rgba(160,200,255,.18);
      --line2:rgba(160,200,255,.12);
      --text:#e7f0ff;
      --muted:rgba(231,240,255,.72);
      --muted2:rgba(231,240,255,.55);
      --accent:#67b1ff;
      --ok:#5de0c2;
      --warn:#ffd166;
      --bad:#ff6b6b;
      --shadow:0 18px 50px rgba(0,0,0,.35);
      --radius:18px;
    }
    html,body{height:100%;}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(103,177,255,.18), transparent 60%),
        radial-gradient(900px 700px at 90% 10%, rgba(93,224,194,.12), transparent 55%),
        radial-gradient(800px 600px at 10% 100%, rgba(255,209,102,.10), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width: 1160px;
      margin: 18px auto 40px;
      padding: 0 14px;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 14px 16px;
      border:1px solid var(--line);
      border-radius: 999px;
      background: rgba(15,24,51,.72);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight: 700;
      letter-spacing:.2px;
    }
    .dot{
      width:10px;height:10px;border-radius:99px;
      background: var(--ok);
      box-shadow: 0 0 0 3px rgba(93,224,194,.15);
    }
    .nav{
      display:flex; gap:10px; align-items:center;
    }
    .nav a{
      color: var(--muted);
      text-decoration:none;
      padding: 8px 12px;
      border-radius: 999px;
      border:1px solid transparent;
    }
    .nav a:hover{
      color: var(--text);
      border-color: var(--line);
      background: rgba(103,177,255,.06);
    }
    .pillOk{
      padding: 8px 12px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(15,24,51,.35);
      color: var(--muted);
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .topTitle{
      margin: 18px 2px 6px;
      font-size: 38px;
      font-weight: 800;
      letter-spacing: .2px;
    }
    .desc{
      margin: 0 2px 18px;
      color: var(--muted);
      line-height: 1.5;
      font-size: 13px;
    }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid2{ grid-template-columns: 1fr; }
    }
    .card{
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(15,24,51,.60);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      padding: 14px 14px 12px;
    }
    .card h2{
      margin: 0 0 10px;
      font-size: 18px;
      letter-spacing:.2px;
    }
    .row{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
    }
    .btn{
      border: 1px solid var(--line);
      background: rgba(15,24,51,.35);
      color: var(--text);
      border-radius: 999px;
      padding: 8px 12px;
      cursor:pointer;
      font-size: 12px;
    }
    .btn:hover{ background: rgba(103,177,255,.08); }
    .kv{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap: 8px 10px;
      margin-top: 10px;
      align-items:center;
    }
    .kv .k{ color: var(--muted2); font-size: 12px; }
    .kv .v{ color: var(--text); font-size: 12px; }
    .pillDir{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      font-size: 12px;
      background: rgba(15,24,51,.35);
    }
    .dirDot{
      width:8px;height:8px;border-radius:99px;
      background: var(--muted2);
    }
    .dirRiskOn .dirDot{ background: var(--ok); }
    .dirRiskOff .dirDot{ background: var(--bad); }
    .dirNeutral .dirDot{ background: var(--warn); }
    .small{ font-size: 12px; color: var(--muted2); }
    .controlsGrid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 980px){
      .controlsGrid{ grid-template-columns: repeat(2, 1fr); }
    }
    .stat{
      border:1px solid var(--line2);
      background: rgba(15,24,51,.32);
      border-radius: 14px;
      padding: 10px 12px;
      min-height: 58px;
    }
    .stat .label{ color: var(--muted2); font-size: 12px; margin-bottom: 6px; }
    .stat .value{ font-size: 18px; font-weight: 700; }
    .stat .mono{ font-size: 12px; color: var(--muted); }
    .split{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      .split{ grid-template-columns: 1fr; }
    }
    .canvasWrap{
      border:1px solid var(--line);
      border-radius: var(--radius);
      overflow:hidden;
      background: rgba(15,24,51,.45);
      box-shadow: var(--shadow);
    }
    .canvasHead{
      display:flex;
      justify-content: space-between;
      align-items:center;
      padding: 10px 12px;
      border-bottom:1px solid var(--line2);
      color: var(--muted);
      font-size: 12px;
    }
    canvas{ display:block; width:100%; height:auto; }
    .sectionTitle{
      margin: 18px 2px 10px;
      font-size: 22px;
      font-weight: 800;
      letter-spacing:.2px;
    }
    table{
      width:100%;
      border-collapse: collapse;
      border:1px solid var(--line);
      border-radius: var(--radius);
      overflow:hidden;
      background: rgba(15,24,51,.55);
      box-shadow: var(--shadow);
    }
    thead th{
      text-align:left;
      font-size: 12px;
      color: var(--muted);
      padding: 10px 10px;
      border-bottom: 1px solid var(--line2);
    }
    tbody td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(160,200,255,.08);
      vertical-align: top;
      font-size: 13px;
    }
    tbody tr:hover{ background: rgba(103,177,255,.06); }
    .thumb{
      width:56px;height:56px;border-radius: 12px;
      border:1px solid var(--line2);
      background: rgba(15,24,51,.35);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      color: var(--muted2);
      font-size: 12px;
    }
    .thumb img{ width:100%; height:100%; object-fit: cover; display:block; }
    .title a{ color: var(--text); text-decoration:none; font-weight: 650; }
    .title a:hover{ text-decoration: underline; }
    .src{ color: var(--muted2); font-size: 12px; margin-top: 2px; }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line2);
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 12px;
      background: rgba(15,24,51,.35);
    }
    .bDot{ width:8px;height:8px;border-radius:99px; background: var(--muted2); }
    .bRisk .bDot{ background: var(--bad); }
    .bOk .bDot{ background: var(--ok); }
    .bNeu .bDot{ background: var(--warn); }
    .num{ font-variant-numeric: tabular-nums; }
    .net{
      border:1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 12px;
      background: rgba(15,24,51,.35);
      display:inline-flex;
      gap: 8px;
      align-items:center;
    }
    .net.ok{ border-color: rgba(93,224,194,.35); color: rgba(93,224,194,.95); }
    .net.risk{ border-color: rgba(255,107,107,.35); color: rgba(255,107,107,.95); }
    .net.neu{ border-color: rgba(255,209,102,.35); color: rgba(255,209,102,.95); }
    .right{
      text-align:right;
    }
    .filterRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 10px;
    }
    .input, .select{
      border:1px solid var(--line);
      background: rgba(15,24,51,.35);
      color: var(--text);
      border-radius: 12px;
      padding: 8px 10px;
      font-size: 12px;
      outline:none;
    }
    .chk{
      display:flex; align-items:center; gap:8px;
      color: var(--muted);
      font-size: 12px;
      user-select:none;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div>GenesisPrediction v2</div>
      </div>
      <div class="nav">
        <a href="/static/index.html">Home</a>
        <a href="/static/overlay.html">Overlay</a>
        <a href="/static/sentiment.html">Sentiment</a>
      </div>
      <div class="pillOk mono" id="asofPill">as_of: -</div>
    </div>

    <div class="topTitle">Sentiment（記事別）</div>
    <div class="desc">
      <span class="mono">/analysis/sentiment_latest.json</span> を主データとして表示します。<br/>
      可能なら <span class="mono">/analysis/view_model_latest.json</span>（+補助メタ）から URL/title を突合してサムネ品質を上げます（読み取りのみ）。
    </div>

    <div class="grid2">
      <div class="card">
        <h2>Controls</h2>

        <div class="row">
          <button class="btn" id="btnReload">Reload</button>
          <button class="btn" id="btnReset">Reset filters</button>
          <button class="btn" id="btnOpenVm">Open view_model_latest.json</button>
          <button class="btn" id="btnOpenSent">Open sentiment_latest.json</button>
          <button class="btn" id="btnOpenTs">Open sentiment_timeseries.csv</button>
        </div>

        <div class="controlsGrid">
          <div class="stat">
            <div class="label">date</div>
            <div class="value mono" id="kpiDate">-</div>
          </div>
          <div class="stat">
            <div class="label">articles</div>
            <div class="value mono" id="kpiArticles">-</div>
          </div>
          <div class="stat">
            <div class="label">risk</div>
            <div class="value mono" id="kpiRisk">-</div>
          </div>
          <div class="stat">
            <div class="label">positive</div>
            <div class="value mono" id="kpiPositive">-</div>
          </div>
          <div class="stat" style="grid-column: span 2;">
            <div class="label">uncertainty</div>
            <div class="value mono" id="kpiUnc">-</div>
          </div>
          <div class="stat" style="grid-column: span 2;">
            <div class="label">note</div>
            <div class="mono" id="kpiNote">-</div>
          </div>
        </div>

        <div class="filterRow">
          <input class="input" id="q" placeholder="search (title/source)" style="min-width:240px;" />
          <select class="select" id="srcSel" style="min-width:180px;"></select>
          <select class="select" id="sortSel" style="min-width:160px;">
            <option value="risk_desc">risk ↓</option>
            <option value="risk_asc">risk ↑</option>
            <option value="pos_desc">positive ↓</option>
            <option value="pos_asc">positive ↑</option>
            <option value="unc_desc">uncertainty ↓</option>
            <option value="unc_asc">uncertainty ↑</option>
            <option value="net_desc">net ↓</option>
            <option value="net_asc">net ↑</option>
          </select>
          <label class="chk">
            <input type="checkbox" id="showMissing" checked />
            show missing
          </label>
          <div class="small mono" id="dbgLine"></div>
        </div>

        <div class="canvasWrap" style="margin-top:12px;">
          <div class="canvasHead">
            <div>Sentiment Trend</div>
            <div class="mono" id="tsInfo">timeseries: -</div>
          </div>
          <canvas id="trend" width="1080" height="420"></canvas>
        </div>
        <div class="small" style="margin-top:8px;">※ risk / positive / uncertainty を<strong>各段・独立スケール</strong>で描画。</div>
      </div>

      <div class="card">
        <h2>How it works</h2>
        <div class="small mono" style="line-height:1.6;">
          1) GET <span class="mono">/analysis/sentiment_latest.json</span>（主）<br/>
          2) GET <span class="mono">/analysis/view_model_latest.json</span>（補助）<br/>
          3) さらに補助メタ候補を探索（読み取りのみ）<br/>
          4) join key: URL優先 → 無ければ title fallback<br/>
          5) サムネ: imageがあれば採用（favicon等の“アイコンURL”は無視）
        </div>

        <div style="margin-top:12px; border:1px solid var(--line2); border-radius:14px; padding:12px; background: rgba(15,24,51,.30);">
          <div style="font-weight:800; font-size: 13px;">TREND3 FX (PHASE 1)</div>
          <div class="kv">
            <div class="k">dir(today)</div>
            <div class="v"><span class="pillDir mono" id="t3Dir"><span class="dirDot"></span><span id="t3DirTxt">NOT_FOUND</span></span></div>

            <div class="k">threshold</div>
            <div class="v mono" id="t3Th">-</div>

            <div class="k">hit_rate(latest)</div>
            <div class="v mono" id="t3Hit">-</div>

            <div class="k">as_of</div>
            <div class="v mono" id="t3AsOf">-</div>

            <div class="k">path</div>
            <div class="v mono" id="t3Path">NOT_FOUND</div>
          </div>

          <div class="small mono" id="dbg2" style="margin-top:10px; white-space:pre-wrap;"></div>
        </div>
      </div>
    </div>

    <div class="sectionTitle">Articles &amp; Sentiment</div>
    <div class="small mono" id="rowsInfo" style="margin: 0 2px 10px;">-</div>

    <table>
      <thead>
        <tr>
          <th style="width:74px;">thumb</th>
          <th>title</th>
          <th style="width:92px;">status</th>
          <th class="right" style="width:92px;">risk</th>
          <th class="right" style="width:92px;">positive</th>
          <th class="right" style="width:110px;">uncertainty</th>
          <th class="right" style="width:110px;">net</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <script>
    // -----------------------
    // Helpers
    // -----------------------
    function fmtNum(x, digits=6){
      if (x === null || x === undefined || Number.isNaN(x)) return "-";
      const n = Number(x);
      if (!Number.isFinite(n)) return "-";
      return n.toFixed(digits);
    }
    function fmtPct(x, digits=2){
      if (x === null || x === undefined || Number.isNaN(x)) return "-";
      const n = Number(x);
      if (!Number.isFinite(n)) return "-";
      const v = (n <= 1.0) ? (n * 100.0) : n;
      return v.toFixed(digits) + "%";
    }
    function normStr(s){
      if (!s) return "";
      return String(s).trim();
    }
    function pickAny(obj, keys){
      if (!obj || typeof obj !== "object") return null;
      for (const k of keys){
        if (obj[k] !== undefined && obj[k] !== null && obj[k] !== "") return obj[k];
      }
      return null;
    }
    function safeHostFromUrl(u){
      try{
        const x = new URL(u);
        return x.host || "";
      }catch(e){
        return "";
      }
    }
    function safeKey(x){
      const u = normStr(x.url);
      if (u) return u;
      return ("t:" + normStr(x.title).toLowerCase());
    }
    function getStatusFromNet(net){
      const n = Number(net);
      if (!Number.isFinite(n)) return "neu";
      if (n < -0.02) return "risk";
      if (n > 0.02) return "ok";
      return "neu";
    }

    async function fetchJsonFirst(paths){
      let lastErr = null;
      for (const p of paths){
        try{
          const r = await fetch(p, { cache:"no-store" });
          if (!r.ok){ lastErr = new Error("HTTP " + r.status + " " + p); continue; }
          const j = await r.json();
          return { ok:true, path:p, json:j };
        }catch(e){ lastErr = e; }
      }
      return { ok:false, path: paths[0] || "-", json:null, err:lastErr };
    }
    async function fetchTextFirst(paths){
      let lastErr = null;
      for (const p of paths){
        try{
          const r = await fetch(p, { cache:"no-store" });
          if (!r.ok){ lastErr = new Error("HTTP " + r.status + " " + p); continue; }
          const t = await r.text();
          return { ok:true, path:p, text:t };
        }catch(e){ lastErr = e; }
      }
      return { ok:false, path: paths[0] || "-", text:"", err:lastErr };
    }

    // -----------------------
    // Image heuristics
    // -----------------------
    function isLikelyIconUrl(u){
      const s = String(u || "").trim();
      if (!s) return false;
      const l = s.toLowerCase();
      // strong signals
      if (l.includes("favicon")) return true;
      if (l.includes("apple-touch-icon")) return true;
      if (l.endsWith(".ico")) return true;
      // common small icon patterns
      if (l.includes("/icon") || l.includes("icon=")) return true;
      if (l.includes("size=16") || l.includes("size=32") || l.includes("size=48") || l.includes("sz=16") || l.includes("sz=32")) return true;
      // often logos (still small) – treat as icon if explicitly labeled
      if (l.includes("logo") && (l.includes("svg") || l.includes("icon"))) return true;
      return false;
    }

    function toImageUrl(v){
      if (!v) return "";
      if (typeof v === "string"){
        const s = v.trim();
        if (!s) return "";
        if (isLikelyIconUrl(s)) return "";
        return s;
      }
      if (Array.isArray(v)){
        for (const it of v){
          const u = toImageUrl(it);
          if (u) return u;
        }
        return "";
      }
      if (typeof v === "object"){
        const u = pickAny(v, ["url","src","href","image","image_url","imageUrl","original","large","medium","small"]);
        if (typeof u === "string"){
          const s = u.trim();
          if (!s) return "";
          if (isLikelyIconUrl(s)) return "";
          return s;
        }
      }
      return "";
    }
    function normalizeSource(v){
      if (!v) return "";
      if (typeof v === "string") return v.trim();
      if (typeof v === "object"){
        const x = pickAny(v, ["name","title","source","publisher","domain"]);
        if (typeof x === "string") return x.trim();
      }
      return "";
    }

    function normalizeMetaItem(x){
      const title = normStr(pickAny(x, ["title","headline","name"])) || "(no title)";
      const url = normStr(pickAny(x, ["url","link"])) || "";
      const sourceRaw = pickAny(x, ["source","source_name","publisher","site","domain"]);
      const source = normalizeSource(sourceRaw);
      const imageRaw = pickAny(x, ["image","image_url","imageUrl","thumbnail","thumbnail_url","thumb","thumb_url","media","og_image","ogImage"]);
      const image = toImageUrl(imageRaw);
      return { title, url, source, image, raw:x };
    }

    function normalizeSentItem(x){
      const title = normStr(pickAny(x, ["title","headline","name"])) || "(no title)";
      const url = normStr(pickAny(x, ["url","link"])) || "";
      const sourceRaw = pickAny(x, ["source","source_name","publisher","site","domain"]);
      const source = normalizeSource(sourceRaw);
      const imageRaw = pickAny(x, ["image","image_url","imageUrl","thumbnail","thumbnail_url","thumb","thumb_url","media","og_image","ogImage"]);
      const image = toImageUrl(imageRaw);

      const risk = pickAny(x, ["risk","risk_score"]);
      const positive = pickAny(x, ["positive","positive_score"]);
      const uncertainty = pickAny(x, ["uncertainty","uncertainty_score"]);
      const net = pickAny(x, ["net","net_score"]);

      return {
        title, url, source, image,
        risk:Number(risk), positive:Number(positive), uncertainty:Number(uncertainty), net:Number(net),
        raw:x
      };
    }

    function flattenAnyArray(json){
      if (!json) return [];
      if (Array.isArray(json)) return json;
      if (typeof json !== "object") return [];
      for (const k of ["items","articles","data","rows","events","results"]){
        if (Array.isArray(json[k])) return json[k];
      }
      return [];
    }

    function buildMetaMap(metaJson){
      const arr = flattenAnyArray(metaJson).map(normalizeMetaItem).filter(x => x.url || x.title);
      const map = new Map();
      for (const x of arr){
        const k = safeKey(x);
        if (!map.has(k)) map.set(k, x);
      }
      return { map, count: arr.length };
    }

    function joinItems(sentItems, metaMaps){
      const joined = [];
      const dbg = {
        sentItems: sentItems.length,
        metaItems: metaMaps.reduce((a,b)=>a+b.count,0),
        joined: 0,
        metaOnly: 0,
        sentOnly: 0
      };

      const metaBestMap = new Map();
      for (const mm of metaMaps){
        for (const [k,v] of mm.map.entries()){
          if (!metaBestMap.has(k)) metaBestMap.set(k, v);
          else{
            // prefer one with image
            const cur = metaBestMap.get(k);
            if ((!cur.image && v.image)) metaBestMap.set(k, v);
          }
        }
      }

      for (const s of sentItems){
        const k = safeKey(s);
        const m = metaBestMap.get(k) || null;

        const title = (m && m.title) ? m.title : s.title;
        const url = (s.url || (m ? m.url : "")) || "";
        const source = (s.source || (m ? m.source : "")) || normalizeSource(safeHostFromUrl(url));

        // image priority: meta first then sentiment (both are filtered by isLikelyIconUrl)
        let image = (m && m.image) ? m.image : (s.image || "");

        const net = Number.isFinite(s.net) ? s.net : (Number(s.positive) - Number(s.risk));
        const status = getStatusFromNet(net);

        joined.push({
          title, url, source, image,
          risk: s.risk, positive: s.positive, uncertainty: s.uncertainty, net,
          status,
          _meta: m,
          _sent: s
        });

        if (m) dbg.joined += 1;
        else dbg.sentOnly += 1;
      }

      // metaOnly rows are not shown; keep debug only
      dbg.metaOnly = metaBestMap.size - dbg.joined;

      return { joined, dbg };
    }

    function sortItems(items, spec){
      const a = items.slice();
      const key = spec.key;
      const dir = spec.dir;

      a.sort((x,y)=>{
        const vx = Number(x[key]);
        const vy = Number(y[key]);
        const ax = Number.isFinite(vx) ? vx : -999999;
        const ay = Number.isFinite(vy) ? vy : -999999;
        if (ax === ay){
          return (x.title||"").localeCompare(y.title||"");
        }
        return dir * (ay - ax);
      });
      return a;
    }

    function getSortSpec(v){
      switch(v){
        case "risk_asc": return { key:"risk", dir:-1 };
        case "risk_desc": return { key:"risk", dir: 1 };
        case "pos_asc": return { key:"positive", dir:-1 };
        case "pos_desc": return { key:"positive", dir: 1 };
        case "unc_asc": return { key:"uncertainty", dir:-1 };
        case "unc_desc": return { key:"uncertainty", dir: 1 };
        case "net_asc": return { key:"net", dir:-1 };
        case "net_desc": return { key:"net", dir: 1 };
        default: return { key:"risk", dir: 1 };
      }
    }

    function buildSourceList(items){
      const set = new Set();
      for (const x of items){
        if (x.source) set.add(x.source);
      }
      return ["All", ...Array.from(set).sort((a,b)=>a.localeCompare(b))];
    }

    function setThumb(el, url, title){
      el.innerHTML = "";
      if (!url){
        el.textContent = "—";
        return;
      }
      const img = document.createElement("img");
      img.loading = "lazy";
      img.referrerPolicy = "no-referrer";
      img.alt = title || "thumb";
      img.src = url;
      img.onerror = () => { el.textContent = "—"; };
      el.appendChild(img);
    }

    function renderTable(items){
      const tbody = document.getElementById("tbody");
      tbody.innerHTML = "";

      for (const x of items){
        const tr = document.createElement("tr");

        const tdThumb = document.createElement("td");
        const th = document.createElement("div");
        th.className = "thumb";

        // ✅ thumb priority:
        // 1) joined/meta image
        // 2) sentiment image
        // (favicon fallback disabled — icons are not thumbnails)
        let thumbUrl = "";
        if (x.image && String(x.image).startsWith("http")) thumbUrl = x.image;

        setThumb(th, thumbUrl, x.title);

        tdThumb.appendChild(th);
        tr.appendChild(tdThumb);

        const tdTitle = document.createElement("td");
        tdTitle.className = "title";
        const a = document.createElement("a");
        a.href = x.url || "#";
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.textContent = x.title || "(no title)";
        tdTitle.appendChild(a);

        const src = document.createElement("div");
        src.className = "src";
        src.textContent = x.source || safeHostFromUrl(x.url) || "(no source)";
        tdTitle.appendChild(src);

        tr.appendChild(tdTitle);

        const tdStatus = document.createElement("td");
        const b = document.createElement("span");
        const st = x.status || "neu";
        b.className = "badge " + (st==="risk" ? "bRisk" : (st==="ok" ? "bOk" : "bNeu"));
        const d = document.createElement("span");
        d.className = "bDot";
        const t = document.createElement("span");
        t.className = "mono";
        t.textContent = st;
        b.appendChild(d);
        b.appendChild(t);
        tdStatus.appendChild(b);
        tr.appendChild(tdStatus);

        function tdNum(val){
          const td = document.createElement("td");
          td.className = "right mono num";
          td.textContent = fmtNum(val, 6);
          return td;
        }

        tr.appendChild(tdNum(x.risk));
        tr.appendChild(tdNum(x.positive));
        tr.appendChild(tdNum(x.uncertainty));

        const tdNet = document.createElement("td");
        tdNet.className = "right";
        const net = document.createElement("span");
        net.className = "net mono num " + (st==="risk" ? "risk" : (st==="ok" ? "ok" : "neu"));
        net.textContent = fmtNum(x.net, 6);
        tdNet.appendChild(net);
        tr.appendChild(tdNet);

        tbody.appendChild(tr);
      }
    }

    // -----------------------
    // Trend canvas (3 panel)
    // -----------------------
    function parseCsv(csv){
      const lines = csv.trim().split(/\r?\n/);
      if (!lines.length) return [];
      const header = lines[0].split(",").map(s=>s.trim());
      const out = [];
      for (let i=1;i<lines.length;i++){
        const row = lines[i].split(",");
        if (row.length < 2) continue;
        const o = {};
        for (let j=0;j<header.length && j<row.length;j++){
          o[header[j]] = row[j].trim();
        }
        out.push(o);
      }
      return out;
    }

    function draw3Panel(canvas, series){
      const ctx = canvas.getContext("2d");
      const W = canvas.width;
      const H = canvas.height;

      ctx.clearRect(0,0,W,H);

      // background
      ctx.fillStyle = "rgba(15,24,51,.65)";
      ctx.fillRect(0,0,W,H);

      const padL=58, padR=18, padT=14, padB=20;
      const gap=10;
      const panelH = (H - padT - padB - gap*2) / 3;

      const panels = [
        { key:"risk", label:"RISK" },
        { key:"positive", label:"POSITIVE" },
        { key:"uncertainty", label:"UNCERTAINTY" }
      ];

      const dates = series.map(x=>x.date).filter(Boolean);
      const xMin=0, xMax=Math.max(0, dates.length-1);

      function getVal(x, key){
        const v = Number(x[key]);
        return Number.isFinite(v) ? v : NaN;
      }

      // helpers
      function line(x1,y1,x2,y2, stroke){
        ctx.strokeStyle = stroke;
        ctx.beginPath();
        ctx.moveTo(x1,y1); ctx.lineTo(x2,y2);
        ctx.stroke();
      }
      function text(s,x,y, fill, align="left"){
        ctx.fillStyle = fill;
        ctx.textAlign = align;
        ctx.fillText(s,x,y);
      }

      ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
      ctx.lineWidth = 1;

      const xTo = (i)=> padL + (xMax===0 ? 0 : (i-xMin) / (xMax-xMin)) * (W-padL-padR);

      panels.forEach((p, idx)=>{
        const y0 = padT + idx*(panelH+gap);
        const y1 = y0 + panelH;

        // frame
        ctx.strokeStyle = "rgba(160,200,255,.16)";
        ctx.strokeRect(padL, y0, W-padL-padR, panelH);

        // data range
        const vals = series.map(x=>getVal(x,p.key)).filter(v=>Number.isFinite(v));
        const vMin = Math.min(...vals, 0);
        const vMax = Math.max(...vals, 0);
        const span = (vMax - vMin) || 1e-9;

        const yTo = (v)=> y1 - ((v - vMin) / span) * panelH;

        // grid + ticks
        ctx.strokeStyle = "rgba(160,200,255,.10)";
        for (let k=0;k<=3;k++){
          const yy = y0 + (k/3)*panelH;
          line(padL, yy, W-padR, yy, "rgba(160,200,255,.10)");
        }

        // labels
        ctx.fillStyle = "rgba(231,240,255,.85)";
        ctx.textAlign = "left";
        ctx.fillText(p.label, padL+6, y0+14);

        // max label
        ctx.textAlign = "right";
        ctx.fillStyle = "rgba(231,240,255,.60)";
        ctx.fillText("max: " + fmtNum(vMax, 6), W-padR-6, y0+14);

        // line plot
        ctx.strokeStyle = "rgba(103,177,255,.95)";
        ctx.lineWidth = 2;
        ctx.beginPath();
        let started=false;
        for (let i=0;i<series.length;i++){
          const v = getVal(series[i], p.key);
          if (!Number.isFinite(v)) continue;
          const xx = xTo(i);
          const yy = yTo(v);
          if (!started){ ctx.moveTo(xx,yy); started=true; }
          else ctx.lineTo(xx,yy);
        }
        ctx.stroke();
        ctx.lineWidth = 1;

        // latest label
        const lastIdx = series.length-1;
        if (lastIdx >= 0){
          const v = getVal(series[lastIdx], p.key);
          if (Number.isFinite(v)){
            const xx = xTo(lastIdx);
            const yy = yTo(v);

            ctx.fillStyle = "rgba(15,24,51,.85)";
            ctx.strokeStyle = "rgba(160,200,255,.22)";
            const boxW = 170, boxH = 32;
            const bx = Math.max(padL+6, xx - boxW - 6);
            const by = Math.max(y0+6, Math.min(y1-boxH-6, yy - boxH/2));
            ctx.fillRect(bx, by, boxW, boxH);
            ctx.strokeRect(bx, by, boxW, boxH);

            ctx.fillStyle = "rgba(231,240,255,.88)";
            ctx.textAlign = "left";
            ctx.fillText("latest: " + fmtNum(v, 6), bx+8, by+14);
            ctx.fillStyle = "rgba(231,240,255,.55)";
            ctx.fillText(series[lastIdx].date || "-", bx+8, by+28);

            // marker
            ctx.fillStyle = "rgba(103,177,255,.95)";
            ctx.beginPath(); ctx.arc(xx,yy,3.2,0,Math.PI*2); ctx.fill();
          }
        }

        // x labels only on bottom panel
        if (idx===2 && dates.length){
          ctx.fillStyle = "rgba(231,240,255,.55)";
          ctx.textAlign = "left";
          ctx.fillText(dates[0], padL, y1+16);
          ctx.textAlign = "right";
          ctx.fillText(dates[dates.length-1], W-padR, y1+16);
        }
      });
    }

    // -----------------------
    // Trend3 FX (Phase 1)
    // -----------------------
    function setDirPill(dir){
      const el = document.getElementById("t3Dir");
      const txt = document.getElementById("t3DirTxt");
      const d = (dir || "NOT_FOUND").toUpperCase();
      txt.textContent = d;

      el.classList.remove("dirRiskOn","dirRiskOff","dirNeutral");
      if (d.includes("RISK_ON")) el.classList.add("dirRiskOn");
      else if (d.includes("RISK_OFF")) el.classList.add("dirRiskOff");
      else if (d.includes("NEUTRAL")) el.classList.add("dirNeutral");
    }

    async function loadTrend3Fx(){
      const candidates = [
        "/analysis/trend3_fx_latest.json",
        "/analysis/fx/trend3_fx_latest.json",
        "/analysis/prediction/trend3_fx_latest.json",
        "/analysis/predictions/trend3_fx_latest.json",
        "/analysis/fx/trend3_fx_latest.json",
        "/static/analysis/trend3_fx_latest.json",
        "/static/analysis/fx/trend3_fx_latest.json",
        "/static/analysis/prediction/trend3_fx_latest.json"
      ];
      const res = await fetchJsonFirst(candidates);

      const pathEl = document.getElementById("t3Path");
      const thEl = document.getElementById("t3Th");
      const hitEl = document.getElementById("t3Hit");
      const asEl = document.getElementById("t3AsOf");
      const dbgEl = document.getElementById("dbg2");

      if (!res.ok){
        pathEl.textContent = "NOT_FOUND (checked " + candidates.length + ")";
        setDirPill("NOT_FOUND");
        thEl.textContent = "-";
        hitEl.textContent = "-";
        asEl.textContent = "-";
        dbgEl.textContent = "";
        return { ok:false, tried:candidates.length };
      }

      const j = res.json || {};
      const dir = pickAny(j, ["dir","direction","today_dir","todayDirection","signal","label"]);
      const th = pickAny(j, ["threshold","th"]);
      const hit = pickAny(j, ["hit_rate","hitRate","latest_hit_rate","latestHitRate"]);
      const asof = pickAny(j, ["as_of","asof","date"]);

      pathEl.textContent = res.path || "-";
      setDirPill(dir || "NEUTRAL");
      thEl.textContent = (th !== null && th !== undefined) ? fmtNum(th, 6) : "-";
      hitEl.textContent = (hit !== null && hit !== undefined) ? fmtPct(hit, 2) : "-";
      asEl.textContent = asof ? String(asof) : "-";

      dbgEl.textContent = "debug2: ok\n" +
        "path=" + (res.path || "-") + "\n" +
        "dir=" + (dir || "-") + "\n" +
        "threshold=" + (th ?? "-") + "\n" +
        "hit_rate=" + (hit ?? "-") + "\n" +
        "as_of=" + (asof || "-");

      return { ok:true, path:res.path };
    }

    // -----------------------
    // Main
    // -----------------------
    const PATH_SENT_CANDS = ["/analysis/sentiment_latest.json", "/static/analysis/sentiment_latest.json"];
    const PATH_VM_CANDS = ["/analysis/view_model_latest.json", "/static/analysis/view_model_latest.json"];
    const PATH_TS_CANDS = ["/analysis/sentiment_timeseries.csv", "/static/analysis/sentiment_timeseries.csv"];

    // meta candidates used only for better title/url/image (NO external access)
    const META_CANDS = [
      "/analysis/view_model_latest.json",
      "/analysis/daily_summary_latest.json",
      "/analysis/daily_news_latest.json",
      "/analysis/world_politics_latest.json",
      "/analysis/world_politics/analysis/events_latest.json",
      "/analysis/events_latest.json",
      "/static/analysis/daily_summary_latest.json",
      "/static/analysis/daily_news_latest.json",
      "/static/analysis/world_politics_latest.json"
    ];

    let state = {
      sentPath: "-",
      vmPath: "-",
      tsPath: "-",
      metaUsed: [],
      joinedAll: [],
      filtered: []
    };

    function openPath(p){ window.open(p, "_blank", "noopener"); }

    async function reloadAll(){
      document.getElementById("dbgLine").textContent = "loading...";
      const asPill = document.getElementById("asofPill");

      // sentiment (main)
      const sentRes = await fetchJsonFirst(PATH_SENT_CANDS);
      state.sentPath = sentRes.path || "-";
      const sentItems = flattenAnyArray(sentRes.json).map(normalizeSentItem);

      // view_model (optional)
      const vmRes = await fetchJsonFirst(PATH_VM_CANDS);
      state.vmPath = vmRes.ok ? (vmRes.path || "-") : "-";

      // meta candidates (optional; local only)
      const metaUsed = [];
      const metaMaps = [];
      for (const p of META_CANDS){
        const r = await fetchJsonFirst([p]);
        if (r.ok && r.json){
          metaUsed.push(p);
          metaMaps.push(buildMetaMap(r.json));
        }
      }
      state.metaUsed = metaUsed;

      // timeseries (trend)
      const tsRes = await fetchTextFirst(PATH_TS_CANDS);
      state.tsPath = tsRes.path || "-";
      const tsRows = tsRes.ok ? parseCsv(tsRes.text) : [];
      const series = tsRows
        .map(r=>({
          date: r.date || r.as_of || r.day || "",
          risk: Number(r.risk),
          positive: Number(r.positive),
          uncertainty: Number(r.uncertainty)
        }))
        .filter(x=>x.date);

      // KPI (from sentiment_latest.json summary if present)
      const asof = pickAny(sentRes.json, ["as_of","date","day"]) || (series.length ? series[series.length-1].date : "-");
      asPill.textContent = "as_of: " + (asof || "-");
      document.getElementById("kpiDate").textContent = String(asof || "-");
      document.getElementById("kpiArticles").textContent = String(sentItems.length || "-");

      // If sentiment_latest.json has summary fields, show; else compute rough
      const kpiRisk = pickAny(sentRes.json, ["risk","risk_mean","avg_risk","mean_risk"]);
      const kpiPos = pickAny(sentRes.json, ["positive","positive_mean","avg_positive","mean_positive"]);
      const kpiUnc = pickAny(sentRes.json, ["uncertainty","uncertainty_mean","avg_uncertainty","mean_uncertainty"]);

      document.getElementById("kpiRisk").textContent = (kpiRisk!==null && kpiRisk!==undefined) ? fmtNum(kpiRisk,6) : "-";
      document.getElementById("kpiPositive").textContent = (kpiPos!==null && kpiPos!==undefined) ? fmtNum(kpiPos,6) : "-";
      document.getElementById("kpiUnc").textContent = (kpiUnc!==null && kpiUnc!==undefined) ? fmtNum(kpiUnc,6) : "-";

      document.getElementById("kpiNote").textContent =
        "join: URL優先 → title fallback / metaItems=" + metaMaps.reduce((a,b)=>a+b.count,0) +
        " sentItems=" + sentItems.length;

      // join & render
      const { joined, dbg } = joinItems(sentItems, metaMaps);
      state.joinedAll = joined;

      // source select
      const srcSel = document.getElementById("srcSel");
      const sources = buildSourceList(joined);
      srcSel.innerHTML = "";
      for (const s of sources){
        const op = document.createElement("option");
        op.value = s;
        op.textContent = s;
        srcSel.appendChild(op);
      }

      // trend
      if (series.length){
        draw3Panel(document.getElementById("trend"), series);
        document.getElementById("tsInfo").textContent =
          "range: " + series[0].date + " .. " + series[series.length-1].date +
          " / points: " + series.length;
      }else{
        document.getElementById("tsInfo").textContent = "timeseries: NOT_FOUND";
      }

      // Trend3 FX
      const t3 = await loadTrend3Fx();

      // debug / info line
      document.getElementById("dbgLine").textContent =
        "src=" + (state.sentPath) +
        " / vm=" + (state.vmPath) +
        " / ts=" + (state.tsPath) +
        " / meta_used=" + metaUsed.length +
        " / joined=" + dbg.joined +
        " / sentOnly=" + dbg.sentOnly;

      applyFilters();
    }

    function applyFilters(){
      const q = normStr(document.getElementById("q").value).toLowerCase();
      const srcSel = document.getElementById("srcSel").value || "All";
      const showMissing = document.getElementById("showMissing").checked;
      const sortSpec = getSortSpec(document.getElementById("sortSel").value);

      let items = state.joinedAll.slice();

      if (srcSel !== "All"){
        items = items.filter(x => (x.source || "") === srcSel);
      }

      if (q){
        items = items.filter(x=>{
          const t = (x.title||"").toLowerCase();
          const s = (x.source||"").toLowerCase();
          return t.includes(q) || s.includes(q);
        });
      }

      if (!showMissing){
        items = items.filter(x => (x.url && x.url.startsWith("http")));
      }

      items = sortItems(items, sortSpec);

      state.filtered = items;

      document.getElementById("rowsInfo").textContent =
        "sent: " + state.sentPath +
        " / meta_used: " + state.metaUsed.join(", ") +
        " / joined: " + state.filtered.length + " / total: " + state.joinedAll.length;

      renderTable(items);
    }

    // -----------------------
    // events
    // -----------------------
    document.getElementById("btnReload").addEventListener("click", ()=>reloadAll());
    document.getElementById("btnReset").addEventListener("click", ()=>{
      document.getElementById("q").value = "";
      document.getElementById("srcSel").value = "All";
      document.getElementById("sortSel").value = "risk_desc";
      document.getElementById("showMissing").checked = true;
      applyFilters();
    });
    document.getElementById("btnOpenVm").addEventListener("click", ()=>openPath("/analysis/view_model_latest.json"));
    document.getElementById("btnOpenSent").addEventListener("click", ()=>openPath("/analysis/sentiment_latest.json"));
    document.getElementById("btnOpenTs").addEventListener("click", ()=>openPath("/analysis/sentiment_timeseries.csv"));

    document.getElementById("q").addEventListener("input", ()=>applyFilters());
    document.getElementById("srcSel").addEventListener("change", ()=>applyFilters());
    document.getElementById("sortSel").addEventListener("change", ()=>applyFilters());
    document.getElementById("showMissing").addEventListener("change", ()=>applyFilters());

    // boot
    reloadAll();
  </script>
</body>
</html>