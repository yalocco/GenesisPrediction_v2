<!-- app/static/sentiment.html -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sentiment</title>

  <style>
    :root{
      --bg:#0b1020;
      --panel:#111a33;
      --panel2:#0f1730;
      --text:#e7ecff;
      --muted:#aab6e6;
      --grid:#25315c;
      --line:#2a386b;
      --accent:#86b7ff;
      --warn:#ffb86b;
      --ok:#7dffb2;
      --bad:#ff7d7d;
    }
    html,body{height:100%;}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", Arial, sans-serif;
      line-height:1.35;
    }
    .wrap{ max-width:1100px; margin:0 auto; padding:14px 14px 24px; }
    header{
      display:flex; align-items:baseline; justify-content:space-between; gap:12px;
      padding:10px 12px; border:1px solid var(--line); border-radius:14px;
      background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    }
    header .title{ font-size:18px; font-weight:800; letter-spacing:0.2px; }
    header .sub{
      font-size:12px; color:var(--muted);
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; text-align:right;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }

    .row{
      margin-top:12px;
      display:flex;
      gap:12px;
      align-items:stretch;
      flex-wrap:wrap;
    }
    .card{
      border:1px solid var(--line);
      border-radius:14px;
      background:var(--panel);
      padding:10px 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.22);
    }
    .card h2{
      margin:0 0 6px 0;
      font-size:13px;
      color:var(--muted);
      font-weight:800;
      letter-spacing:0.3px;
      text-transform:uppercase;
    }
    .k{ color:var(--muted); }
    .v{ color:var(--text); font-weight:700; }

    .grid2{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap:6px 10px;
      align-items:center;
      font-size:13px;
    }
    .small{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* KPI */
    .kpibox{ flex: 1 1 360px; min-width: 320px; }
    .kpiGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:8px;
    }
    .kpi{
      border:1px solid rgba(255,255,255,0.08);
      border-radius:12px;
      background:rgba(0,0,0,0.10);
      padding:8px 10px;
    }
    .kpi .label{ font-size:12px; color:var(--muted); margin-bottom:4px; }
    .kpi .value{ font-size:14px; font-weight:900; }
    .kpiWide{ grid-column: 1 / -1; }

    /* Trend3 Phase1 */
    .trend3card{ flex: 1 1 420px; min-width: 320px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:4px 10px;
      border-radius:999px; border:1px solid var(--line);
      background:rgba(255,255,255,0.03); font-weight:900; letter-spacing:0.2px;
      width:max-content;
    }
    .dot{ width:9px;height:9px;border-radius:50%; background:var(--muted);
      box-shadow: 0 0 0 3px rgba(255,255,255,0.04); }
    .dir-riskon .dot{ background:var(--warn); }
    .dir-riskoff .dot{ background:var(--ok); }
    .dir-neutral .dot{ background:var(--accent); }
    .dir-unknown .dot{ background:var(--muted); }

    /* Trend graph */
    .trendwrap{
      margin-top:12px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:14px;
      background:var(--panel2);
    }
    .trendhead{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
    .trendhead .h{ font-size:14px; font-weight:900; }
    .trendhead .meta{
      font-size:12px;
      color:var(--muted);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      text-align:right;
    }
    canvas#trend{
      width:100%;
      height:460px;
      display:block;
      border-radius:12px;
      background:rgba(0,0,0,0.10);
      border:1px solid rgba(255,255,255,0.06);
    }

    /* Articles */
    .articles{
      margin-top:12px;
      border:1px solid var(--line);
      border-radius:14px;
      background:var(--panel);
      overflow:hidden;
    }
    .articlesHead{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      flex-wrap:wrap;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      background:rgba(255,255,255,0.02);
    }
    .articlesHead .h{ font-size:14px; font-weight:900; }
    .articlesHead .meta{
      font-size:12px;
      color:var(--muted);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      text-align:right;
    }
    .list{
      padding:10px 12px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:10px 12px;
      padding:10px;
      border:1px solid rgba(255,255,255,0.06);
      border-radius:14px;
      background:rgba(0,0,0,0.10);
    }
    .thumb{
      width:120px;
      height:78px;
      border-radius:12px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.03);
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      font-size:12px;
      user-select:none;
      position:relative;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .thumb .fallbackIcon{
      width:40px; height:40px; border-radius:10px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(0,0,0,0.20);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
    }
    .thumb .fallbackIcon img{
      width:24px; height:24px; object-fit:contain; opacity:0.9;
    }
    .content{ display:flex; flex-direction:column; gap:8px; min-width:0; }
    .titleLine{ display:flex; gap:10px; align-items:baseline; flex-wrap:wrap; min-width:0; }
    .titleLine a{
      color:var(--text);
      font-weight:900;
      text-decoration:none;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:100%;
    }
    .titleLine a:hover{ text-decoration:underline; }
    .metaLine{
      color:var(--muted);
      font-size:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .metrics{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      font-size:12px;
      align-items:center;
    }
    .m{
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.03);
      border-radius:999px;
      padding:3px 8px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    .badge{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      font-size:12px;
      font-weight:900;
      background:rgba(255,255,255,0.03);
      color:var(--text);
    }
    .badge.ok{ border-color:rgba(125,255,178,0.35); }
    .badge.warn{ border-color:rgba(255,184,107,0.35); }
    .badge.bad{ border-color:rgba(255,125,125,0.35); }
    .net{ font-weight:900; }
    .net.bad{ color:var(--bad); }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">Sentiment</div>
      <div class="sub">
        <span id="asof" class="mono">as_of: -</span>
        <span id="src" class="mono">src: /analysis/sentiment_timeseries.csv</span>
      </div>
    </header>

    <div class="row">
      <div class="card kpibox">
        <h2>KPI</h2>
        <div class="grid2">
          <div class="k">path</div>
          <div class="v mono" id="kpi_path">/analysis/view_model_latest.json</div>
        </div>
        <div class="kpiGrid">
          <div class="kpi">
            <div class="label">date</div>
            <div class="value mono" id="kpi_date">-</div>
          </div>
          <div class="kpi">
            <div class="label">articles</div>
            <div class="value mono" id="kpi_articles">-</div>
          </div>
          <div class="kpi">
            <div class="label">risk</div>
            <div class="value mono" id="kpi_risk">-</div>
          </div>
          <div class="kpi">
            <div class="label">positive</div>
            <div class="value mono" id="kpi_pos">-</div>
          </div>
          <div class="kpi kpiWide">
            <div class="label">uncertainty</div>
            <div class="value mono" id="kpi_unc">-</div>
          </div>
        </div>
        <div class="small mono" id="kpi_note">note: view_model_latest.json (display only)</div>
      </div>

      <div class="card trend3card">
        <h2>Trend3 FX (Phase 1)</h2>
        <div class="grid2">
          <div class="k">dir (today)</div>
          <div class="v">
            <span id="t3_dir_pill" class="pill dir-unknown">
              <span class="dot"></span>
              <span id="t3_dir" class="mono">LOADING</span>
            </span>
          </div>

          <div class="k">threshold</div>
          <div class="v mono" id="t3_threshold">-</div>

          <div class="k">hit_rate (latest)</div>
          <div class="v mono" id="t3_hit">-</div>

          <div class="k">as_of</div>
          <div class="v mono" id="t3_asof">-</div>
        </div>
        <div class="small mono" id="t3_path">path: (searching...)</div>
      </div>
    </div>

    <div class="trendwrap">
      <div class="trendhead">
        <div class="h">Sentiment Trend</div>
        <div class="meta">
          <span class="mono" id="range">range: -</span>
          <span class="mono" id="points">points: -</span>
        </div>
      </div>
      <canvas id="trend" width="1100" height="460"></canvas>
    </div>

    <div class="articles" id="articles" style="display:none;">
      <div class="articlesHead">
        <div class="h">Articles</div>
        <div class="meta">
          <span class="mono" id="a_src">src: -</span>
          <span class="mono" id="a_count">count: -</span>
        </div>
      </div>
      <div class="list" id="alist"></div>
    </div>
  </div>

  <script>
    // =========================
    // Utilities
    // =========================
    function fmtNum(x, digits=6){
      if (x === null || x === undefined || Number.isNaN(x)) return "-";
      const n = Number(x);
      if (!Number.isFinite(n)) return "-";
      return n.toFixed(digits);
    }
    function fmtPct(x, digits=2){
      if (x === null || x === undefined || Number.isNaN(x)) return "-";
      const n = Number(x);
      if (!Number.isFinite(n)) return "-";
      const v = (n <= 1.00001) ? (n * 100) : n;
      return v.toFixed(digits) + "%";
    }
    function safeText(id, text){
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = String(text);
    }
    async function fetchTextFirst(paths){
      let lastErr = null;
      for (const p of paths){
        try{
          const r = await fetch(p, { cache: "no-store" });
          if (!r.ok) { lastErr = new Error("HTTP " + r.status + " " + p); continue; }
          const t = await r.text();
          return { ok:true, path:p, text:t };
        }catch(e){ lastErr = e; }
      }
      return { ok:false, path: paths[0] || "-", text:"", err:lastErr };
    }
    async function fetchJsonFirst(paths){
      let lastErr = null;
      for (const p of paths){
        try{
          const r = await fetch(p, { cache: "no-store" });
          if (!r.ok) { lastErr = new Error("HTTP " + r.status + " " + p); continue; }
          const j = await r.json();
          return { ok:true, path:p, json:j };
        }catch(e){ lastErr = e; }
      }
      return { ok:false, path: paths[0] || "-", json:null, err:lastErr };
    }
    function toNum(v){
      if (v === null || v === undefined) return NaN;
      const s = String(v).trim();
      if (s === "") return NaN;
      return Number(s);
    }
    function pick(obj, keys){
      for (const k of keys){
        if (!k) continue;
        const parts = k.split(".");
        let cur = obj;
        let ok = true;
        for (const part of parts){
          if (cur && Object.prototype.hasOwnProperty.call(cur, part)) cur = cur[part];
          else { ok = false; break; }
        }
        if (ok && cur !== undefined && cur !== null) return cur;
      }
      return null;
    }
    function pickAny(o, keys){
      for (const k of keys){
        if (o && Object.prototype.hasOwnProperty.call(o, k) && o[k] !== null && o[k] !== undefined) return o[k];
      }
      return null;
    }
    function toPlainText(v){
      if (v === null || v === undefined) return "";
      if (typeof v === "string") return v;
      if (typeof v === "number" || typeof v === "boolean") return String(v);
      if (v && typeof v === "object"){
        const s =
          pickAny(v, ["name","title","source","publisher","value","text"]) ||
          pickAny(v, ["date","datetime","time","published_at","publishedAt"]) ||
          "";
        if (typeof s === "string") return s;
        try{ return JSON.stringify(v); }catch{ return ""; }
      }
      return "";
    }
    function toImageUrl(v){
      if (!v) return "";
      if (typeof v === "string") return v;
      if (Array.isArray(v)){
        for (const it of v){
          const u = toImageUrl(it);
          if (u) return u;
        }
        return "";
      }
      if (typeof v === "object"){
        const u =
          pickAny(v, ["url","src","href","image","image_url","imageUrl","original","large","medium","small"]) ||
          "";
        if (typeof u === "string") return u;
        for (const k of ["image","thumbnail","thumb","media","og","meta"]){
          const nested = v[k];
          const nu = toImageUrl(nested);
          if (nu) return nu;
        }
      }
      return "";
    }

    // =========================
    // KPI (view_model_latest.json)
    // =========================
    async function loadKpi(){
      const candidates = [
        "/analysis/view_model_latest.json",
        "../analysis/view_model_latest.json",
        "./analysis/view_model_latest.json"
      ];
      const res = await fetchJsonFirst(candidates);
      if (!res.ok){
        safeText("kpi_path", "NOT_FOUND (checked " + candidates.length + ")");
        safeText("kpi_date", "-");
        safeText("kpi_articles", "-");
        safeText("kpi_risk", "-");
        safeText("kpi_pos", "-");
        safeText("kpi_unc", "-");
        return;
      }
      safeText("kpi_path", res.path);

      const j = res.json || {};
      const date = pick(j, ["date","as_of","meta.date","meta.as_of"]) || "-";
      const articles = pick(j, ["articles","kpi.articles","summary.articles","counts.articles"]) ?? "-";
      const risk = pick(j, ["risk","kpi.risk","summary.risk","sentiment.risk"]) ?? null;
      const pos  = pick(j, ["positive","kpi.positive","summary.positive","sentiment.positive"]) ?? null;
      const unc  = pick(j, ["uncertainty","kpi.uncertainty","summary.uncertainty","sentiment.uncertainty"]) ?? null;

      safeText("kpi_date", String(date));
      safeText("kpi_articles", String(articles));
      safeText("kpi_risk", fmtNum(risk, 6));
      safeText("kpi_pos", fmtNum(pos, 6));
      safeText("kpi_unc", fmtNum(unc, 6));
    }

    // =========================
    // Trend3 FX (Phase 1)
    // =========================
    function normalizeDir(raw){
      if (!raw) return { dir:"UNKNOWN", cls:"dir-unknown" };
      const s = String(raw).trim().toUpperCase();
      if (s === "RISK_ON" || s === "RISKON" || s === "ON") return { dir:"RISK_ON", cls:"dir-riskon" };
      if (s === "RISK_OFF" || s === "RISKOFF" || s === "OFF") return { dir:"RISK_OFF", cls:"dir-riskoff" };
      if (s === "NEUTRAL" || s === "FLAT") return { dir:"NEUTRAL", cls:"dir-neutral" };
      return { dir:s, cls:"dir-unknown" };
    }
    function renderTrend3(json, path){
      const dirRaw = pick(json, ["dir","direction","today_dir","today.direction","prediction.dir","prediction.direction","trend3.dir","trend3.direction"]);
      const threshold = pick(json, ["threshold","params.threshold","prediction.threshold","trend3.threshold"]);
      const hitRate = pick(json, ["hit_rate","metrics.hit_rate","latest.hit_rate","prediction.hit_rate","trend3.hit_rate"]);
      const asOf = pick(json, ["as_of","date","generated_at","updated_at","meta.as_of","meta.date"]);

      const { dir, cls } = normalizeDir(dirRaw);
      const pill = document.getElementById("t3_dir_pill");
      if (pill) pill.className = "pill " + cls;

      safeText("t3_dir", dir);
      if (threshold && typeof threshold === "object") safeText("t3_threshold", JSON.stringify(threshold));
      else safeText("t3_threshold", fmtNum(threshold, 6));
      safeText("t3_hit", fmtPct(hitRate, 2));
      safeText("t3_asof", asOf ? String(asOf) : "-");
      safeText("t3_path", "path: " + (path || "-"));
    }
    async function loadTrend3Phase1(){
      const candidates = [
        "/analysis/fx/trend3_fx_latest.json",
        "/analysis/trend3_fx_latest.json",
        "../analysis/fx/trend3_fx_latest.json",
        "../analysis/trend3_fx_latest.json",
        "./analysis/fx/trend3_fx_latest.json",
        "./analysis/fx/trend3_fx_latest.json"
      ];
      const res = await fetchJsonFirst(candidates);
      if (!res.ok){
        const pill = document.getElementById("t3_dir_pill");
        if (pill) pill.className = "pill dir-unknown";
        safeText("t3_dir", "NOT_FOUND");
        safeText("t3_threshold", "-");
        safeText("t3_hit", "-");
        safeText("t3_asof", "-");
        safeText("t3_path", "path: NOT_FOUND (checked " + candidates.length + " candidates)");
        return;
      }
      renderTrend3(res.json || {}, res.path);
    }

    // =========================
    // Sentiment timeseries (3 panels) - Canvas draw
    // =========================
    function parseCSV(text){
      const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
      if (lines.length < 2) return [];
      const header = lines[0].split(",").map(s => s.trim());
      const rows = [];
      for (let i=1; i<lines.length; i++){
        const cols = lines[i].split(",");
        const obj = {};
        for (let c=0; c<header.length; c++){
          obj[header[c]] = (cols[c] !== undefined) ? cols[c].trim() : "";
        }
        rows.push(obj);
      }
      return rows;
    }
    function drawTrend3Panel(ctx, rect, series, label, valueKey){
      const padL = 56, padR = 12, padT = 22, padB = 26;
      const x0 = rect.x + padL;
      const y0 = rect.y + padT;
      const w = rect.w - padL - padR;
      const h = rect.h - padT - padB;

      ctx.save();
      ctx.fillStyle = "rgba(255,255,255,0.02)";
      ctx.fillRect(rect.x, rect.y, rect.w, rect.h);
      ctx.strokeStyle = "rgba(255,255,255,0.06)";
      ctx.strokeRect(rect.x + 0.5, rect.y + 0.5, rect.w - 1, rect.h - 1);

      ctx.fillStyle = "rgba(231,236,255,0.92)";
      ctx.font = "900 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText(label, rect.x + 10, rect.y + 15);

      const vals = series.map(d => d[valueKey]).filter(v => Number.isFinite(v));
      let vmin = 0, vmax = 1;
      if (vals.length > 0){
        vmin = Math.min(...vals);
        vmax = Math.max(...vals);
        if (vmax === vmin) vmax = vmin + 1e-6;
        const m = (vmax - vmin) * 0.08;
        vmin -= m; vmax += m;
      }

      ctx.strokeStyle = "rgba(170,182,230,0.14)";
      ctx.lineWidth = 1;
      ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace";
      ctx.fillStyle = "rgba(170,182,230,0.85)";

      for (let g=0; g<=3; g++){
        const yy = y0 + (h * g / 3);
        ctx.beginPath();
        ctx.moveTo(x0, yy);
        ctx.lineTo(x0 + w, yy);
        ctx.stroke();

        const val = vmax - ( (vmax - vmin) * g / 3 );
        ctx.fillText(val.toFixed(4), rect.x + 10, yy + 4);
      }

      const n = series.length;
      if (n >= 2){
        ctx.fillStyle = "rgba(170,182,230,0.75)";
        const leftDate = series[0].date || "";
        const rightDate = series[n-1].date || "";
        ctx.fillText(String(leftDate), x0, rect.y + rect.h - 10);
        const mW = ctx.measureText(String(rightDate)).width;
        ctx.fillText(String(rightDate), x0 + w - mW, rect.y + rect.h - 10);
      }

      ctx.strokeStyle = "rgba(134,183,255,0.95)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      for (let i=0; i<n; i++){
        const vx = x0 + (w * i / Math.max(1,(n-1)));
        const v = series[i][valueKey];
        if (!Number.isFinite(v)) continue;
        const vy = y0 + (h * (1 - (v - vmin) / (vmax - vmin)));
        if (i === 0) ctx.moveTo(vx, vy);
        else ctx.lineTo(vx, vy);
      }
      ctx.stroke();

      const latest = series[n-1] || null;
      if (latest && Number.isFinite(latest[valueKey])){
        ctx.fillStyle = "rgba(231,236,255,0.92)";
        ctx.font = "900 12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace";
        ctx.fillText("latest: " + latest[valueKey].toFixed(6), rect.x + 10, rect.y + rect.h - 8 - 14);

        const maxText = "max: " + (Math.max(...vals)).toFixed(6);
        const mw = ctx.measureText(maxText).width;
        ctx.fillStyle = "rgba(170,182,230,0.92)";
        ctx.fillText(maxText, rect.x + rect.w - 10 - mw, rect.y + 15);
      }

      ctx.restore();
    }
    function drawTrendCanvas(data){
      const canvas = document.getElementById("trend");
      const ctx = canvas.getContext("2d");

      const cssW = canvas.clientWidth || 1100;
      const cssH = canvas.clientHeight || 460;
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.floor(cssW * dpr);
      canvas.height = Math.floor(cssH * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);

      ctx.clearRect(0,0,cssW,cssH);

      const gap = 10;
      const panelH = Math.floor((cssH - gap*2) / 3);
      const panels = [
        { x:0, y:0, w:cssW, h:panelH, label:"RISK", key:"risk" },
        { x:0, y:panelH + gap, w:cssW, h:panelH, label:"POSITIVE", key:"positive" },
        { x:0, y:(panelH + gap)*2, w:cssW, h:panelH, label:"UNCERTAINTY", key:"uncertainty" }
      ];
      for (const p of panels){
        drawTrend3Panel(ctx, p, data, p.label, p.key);
      }
    }
    async function loadSentimentTrend(){
      const candidates = [
        "/analysis/sentiment_timeseries.csv",
        "../analysis/sentiment_timeseries.csv",
        "./analysis/sentiment_timeseries.csv"
      ];
      const res = await fetchTextFirst(candidates);
      if (!res.ok){
        safeText("asof", "as_of: NOT_FOUND");
        safeText("range", "range: -");
        safeText("points", "points: 0");
        return [];
      }
      safeText("src", "src: " + res.path);

      const rows = parseCSV(res.text);
      const series = rows.map(r => ({
        date: r.date || r.Date || r.DAY || r.day || "",
        risk: toNum(r.risk ?? r.RISK),
        positive: toNum(r.positive ?? r.POSITIVE),
        uncertainty: toNum(r.uncertainty ?? r.UNCERTAINTY),
      })).filter(d => d.date);

      if (series.length > 0){
        safeText("asof", "as_of: " + String(series[series.length-1].date));
        safeText("range", "range: " + String(series[0].date) + " .. " + String(series[series.length-1].date));
        safeText("points", "points: " + String(series.length));
      }else{
        safeText("asof", "as_of: -");
        safeText("range", "range: -");
        safeText("points", "points: 0");
      }

      drawTrendCanvas(series);
      return series;
    }
    function onResizeRedraw(cache){
      if (!cache || cache.length === 0) return;
      drawTrendCanvas(cache);
    }

    // =========================
    // Articles thumbnails: OG image via r.jina.ai -> fallback screenshot -> favicon
    // =========================
    function faviconUrlFromArticleUrl(articleUrl){
      try{
        const u = new URL(articleUrl);
        return "https://www.google.com/s2/favicons?domain=" + encodeURIComponent(u.hostname) + "&sz=128";
      }catch{
        return "";
      }
    }
    function screenshotThumbCandidates(articleUrl){
      const u = encodeURIComponent(articleUrl);
      return [
        "https://image.thum.io/get/width/240/crop/160/noanimate/" + articleUrl,
        "https://s0.wp.com/mshots/v1/" + u + "?w=240"
      ];
    }
    function classifyNet(net){
      const n = Number(net);
      if (!Number.isFinite(n)) return "warn";
      if (n > 0.02) return "ok";
      if (n < -0.02) return "bad";
      return "warn";
    }
    function normalizeArticle(a){
      const title = toPlainText(pickAny(a, ["title","headline","name"])) || "(no title)";
      const url = toPlainText(pickAny(a, ["url","link"])) || "";

      const imageRaw = pickAny(a, ["image","image_url","imageUrl","thumbnail","thumbnail_url","thumb","thumb_url","media","og_image","ogImage"]);
      const image = toImageUrl(imageRaw);

      const dateRaw = pickAny(a, ["date","published_at","publishedAt","time","timestamp"]);
      const sourceRaw = pickAny(a, ["source","source_name","publisher","site","domain"]);
      const date = toPlainText(dateRaw);
      const source = toPlainText(sourceRaw);

      const risk = pickAny(a, ["risk","risk_score"]);
      const positive = pickAny(a, ["positive","positive_score"]);
      const uncertainty = pickAny(a, ["uncertainty","uncertainty_score"]);

      let net = pickAny(a, ["net","net_score"]);
      if (net === null || net === undefined){
        const pr = Number(positive);
        const rr = Number(risk);
        if (Number.isFinite(pr) && Number.isFinite(rr)) net = pr - rr;
      }

      const favicon = url ? faviconUrlFromArticleUrl(url) : "";
      const shots = url ? screenshotThumbCandidates(url) : [];
      return { title, url, image, favicon, shots, date, source, risk, positive, uncertainty, net };
    }

    function setNoImage(thumbEl){
      thumbEl.textContent = "no image";
    }
    function setFavicon(thumbEl, favicon){
      if (!favicon){ setNoImage(thumbEl); return; }
      thumbEl.innerHTML = "";
      const box = document.createElement("div");
      box.className = "fallbackIcon";
      const img = document.createElement("img");
      img.alt = "favicon";
      img.loading = "lazy";
      img.referrerPolicy = "no-referrer";
      img.src = favicon;
      img.onerror = () => { box.innerHTML = "no image"; };
      box.appendChild(img);
      thumbEl.appendChild(box);
    }
    function setImage(thumbEl, src, onError){
      thumbEl.innerHTML = "";
      const img = document.createElement("img");
      img.alt = "thumb";
      img.loading = "lazy";
      img.referrerPolicy = "no-referrer";
      img.src = src;
      img.onerror = () => { if (onError) onError(); };
      thumbEl.appendChild(img);
    }

    // --- OG image extraction via r.jina.ai (CORS回避用)
    // returns "" if not found
    function extractOgImageFromHtml(html){
      if (!html) return "";
      // meta property="og:image" or name="twitter:image"
      const candidates = [
        /<meta[^>]+property=["']og:image["'][^>]+content=["']([^"']+)["'][^>]*>/i,
        /<meta[^>]+content=["']([^"']+)["'][^>]+property=["']og:image["'][^>]*>/i,
        /<meta[^>]+name=["']twitter:image["'][^>]+content=["']([^"']+)["'][^>]*>/i,
        /<meta[^>]+content=["']([^"']+)["'][^>]+name=["']twitter:image["'][^>]*>/i
      ];
      for (const re of candidates){
        const m = html.match(re);
        if (m && m[1]) return m[1].trim();
      }
      return "";
    }

    // simple concurrency limiter
    function createLimiter(max){
      let active = 0;
      const q = [];
      const next = () => {
        if (active >= max) return;
        const job = q.shift();
        if (!job) return;
        active++;
        Promise.resolve()
          .then(job.fn)
          .then(job.resolve, job.reject)
          .finally(() => { active--; next(); });
      };
      return function run(fn){
        return new Promise((resolve, reject) => {
          q.push({ fn, resolve, reject });
          next();
        });
      };
    }
    const limit4 = createLimiter(4);

    async function fetchOgImage(url){
      // try both https/http via jina
      const u = encodeURIComponent(url);
      const candidates = [
        "https://r.jina.ai/http/" + url.replace(/^https?:\/\//i, ""),
        "https://r.jina.ai/https/" + url.replace(/^https?:\/\//i, "")
      ];
      for (const p of candidates){
        try{
          const r = await fetch(p, { cache:"no-store" });
          if (!r.ok) continue;
          const t = await r.text();
          const og = extractOgImageFromHtml(t);
          if (og) return og;
        }catch{}
      }
      return "";
    }

    function renderThumb(thumbEl, a){
      // Priority:
      // 1) JSON image URL
      // 2) OG image via r.jina.ai (async)
      // 3) screenshot services
      // 4) favicon
      // 5) no image

      const jsonImg = (a.image && typeof a.image === "string" && a.image.startsWith("http")) ? a.image : "";
      if (jsonImg){
        setImage(thumbEl, jsonImg, () => {
          // fallback chain
          tryOgOrFallback();
        });
        return;
      }

      tryOgOrFallback();

      function tryScreens(idx){
        if (!a.shots || idx >= a.shots.length){
          setFavicon(thumbEl, a.favicon || "");
          return;
        }
        setImage(thumbEl, a.shots[idx], () => tryScreens(idx + 1));
      }

      function tryOgOrFallback(){
        // show favicon immediately as a placeholder (fast)
        setFavicon(thumbEl, a.favicon || "");

        if (!a.url){
          return;
        }

        // async: fetch OG image, then replace thumb if found
        limit4(async () => {
          const og = await fetchOgImage(a.url);
          if (og && og.startsWith("http")){
            setImage(thumbEl, og, () => tryScreens(0));
          }else{
            // no og -> screenshots
            tryScreens(0);
          }
        });
      }
    }

    function renderArticles(json, path){
      let arr = null;
      if (Array.isArray(json)) arr = json;
      else arr = pick(json, ["articles","items","data.articles","data.items"]);

      if (!Array.isArray(arr) || arr.length === 0) return;

      const list = document.getElementById("alist");
      const box = document.getElementById("articles");
      if (!list || !box) return;

      list.innerHTML = "";

      const normalized = arr.map(normalizeArticle);

      for (const a of normalized){
        const badgeClass = classifyNet(a.net);

        const risk = fmtNum(a.risk, 6);
        const pos = fmtNum(a.positive, 6);
        const unc = fmtNum(a.uncertainty, 6);
        const net = (a.net === null || a.net === undefined) ? "-" : fmtNum(a.net, 6);

        const item = document.createElement("div");
        item.className = "item";

        const thumb = document.createElement("div");
        thumb.className = "thumb";
        renderThumb(thumb, a);

        const content = document.createElement("div");
        content.className = "content";

        const titleLine = document.createElement("div");
        titleLine.className = "titleLine";
        if (a.url){
          const link = document.createElement("a");
          link.href = a.url;
          link.target = "_blank";
          link.rel = "noopener noreferrer";
          link.textContent = a.title;
          titleLine.appendChild(link);
        }else{
          const span = document.createElement("span");
          span.textContent = a.title;
          span.style.fontWeight = "900";
          titleLine.appendChild(span);
        }

        const metaLine = document.createElement("div");
        metaLine.className = "metaLine";
        const bits = [];
        if (a.date) bits.push(`<span class="mono">${a.date}</span>`);
        if (a.source) bits.push(`<span>${a.source}</span>`);
        metaLine.innerHTML = bits.join("");

        const metrics = document.createElement("div");
        metrics.className = "metrics";
        metrics.innerHTML = `
          <span class="m">risk ${risk}</span>
          <span class="m">pos ${pos}</span>
          <span class="m">unc ${unc}</span>
          <span class="badge ${badgeClass}">net <span class="net ${badgeClass==="bad" ? "bad":""}">${net}</span></span>
        `;

        content.appendChild(titleLine);
        if (bits.length > 0) content.appendChild(metaLine);
        content.appendChild(metrics);

        item.appendChild(thumb);
        item.appendChild(content);

        list.appendChild(item);
      }

      box.style.display = "";
      safeText("a_src", "src: " + (path || "-"));
      safeText("a_count", "count: " + String(arr.length));
    }

    async function loadArticles(){
      const latestCandidates = [
        "/analysis/sentiment_latest.json",
        "../analysis/sentiment_latest.json",
        "./analysis/sentiment_latest.json"
      ];
      let res = await fetchJsonFirst(latestCandidates);
      if (res.ok){
        renderArticles(res.json || {}, res.path);
        return;
      }

      const asofText = document.getElementById("asof")?.textContent || "";
      const m = asofText.match(/(\d{4}-\d{2}-\d{2})/);
      const d = m ? m[1] : null;
      if (!d) return;

      const dailyCandidates = [
        `/analysis/sentiment_${d}.json`,
        `../analysis/sentiment_${d}.json`,
        `./analysis/sentiment_${d}.json`
      ];
      res = await fetchJsonFirst(dailyCandidates);
      if (res.ok) renderArticles(res.json || {}, res.path);
    }

    // =========================
    // Boot
    // =========================
    (async function main(){
      await loadKpi();
      await loadTrend3Phase1();
      const series = await loadSentimentTrend();
      window.addEventListener("resize", () => onResizeRedraw(series), { passive:true });
      await loadArticles();
    })();
  </script>
</body>
</html>