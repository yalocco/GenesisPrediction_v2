この文書は、GenesisPrediction_v2 の現行設計における
「壊れやすいポイント」と、その最小対策を整理したものである。

この文書は、GenesisPrediction_v2 の現行設計における
「壊れやすいポイント」と、その最小対策を整理したものである。

---

## 1. 外部 API / オンチェーンデータへの依存（fetcher）

### 概要
fetcher は外部 API（例：取引所 API、オンチェーン RPC）に強く依存しており、
レート制限、ネットワーク障害、部分的なレスポンス欠損の影響を直接受けやすい。

### 想定される問題
- API レートリミット超過による一時的失敗
- 一部データ欠損のまま処理が進行する
- 再実行時に重複データが生成される

### 壊れやすさの本質
- fetcher が「失敗＝全体失敗」になりやすい
- 再実行時の冪等性（idempotency）が保証されていない場合、
  downstream（analyzer / scripts）に影響が波及する

### 最小対策（推奨）
- fetcher 処理を **idempotent** に設計する  
  （同一日付・同一キーで再実行しても結果が変わらない）
- retry 回数に上限を設け、指数バックオフを使用する
- 成功・失敗を `metrics.json` 等に明示的に記録する
- 致命的失敗時のみ通知（Slack 等）を行い、ノイズを増やさない

---

## 2. 単一 DAG / 直列実行によるボトルネック（Airflow）

### 概要
fetcher → analyzer → scripts → data が
単一の直列フローとして実行される場合、
一部ステップの失敗が全体停止につながりやすい。

### 想定される問題
- 一時的な失敗で DAG 全体が停止
- 再実行時に「どこから再開すべきか」が分かりにくい
- 処理時間の増大によりスケジューリング遅延が発生

### 壊れやすさの本質
- ステップ間の責務境界が曖昧
- 部分成功（partial success）を許容できていない

### 最小対策（推奨）
- DAG を論理的に分割し、ステップ単位で成功判定を持たせる
- `depends_on_past` を適切に使用し、不要な再実行を防ぐ
- `on_failure_callback` を用いて失敗箇所を即時可視化する
- 「fetcher 成功・analyzer 未実行」などの状態を許容する設計とする

---

## 3. S3 への一括アップロード・データ永続化の脆弱性

### 概要
data ステップでは、結果を S3 にアップロードすることで永続化を行う。
この工程が失敗すると、計算結果が失われるリスクがある。

### 想定される問題
- ネットワーク断によるアップロード失敗
- 大きなファイル転送中の部分失敗
- 成功・失敗の判定が曖昧になる

### 壊れやすさの本質
- アップロード単位が大きく、再試行コストが高い
- 部分成功を記録できない設計

### 最小対策（推奨）
- multipart upload を使用し、部分成功を許容する
- ETag を用いた整合性チェックを行う
- raw / processed / results / models を明確に分離して保存する
- アップロード完了をメタデータとして明示的に記録する

---

## まとめ

GenesisPrediction_v2 における主な壊れやすさは以下の 3 点に集約される。

| 領域 | 壊れやすさ | 最小対策 |
|---|---|---|
| fetcher | 外部依存・再実行不安定 | 冪等性・retry 制御 |
| Airflow | 直列依存・再開困難 | DAG 分割・部分成功 |
| S3 upload | 一括処理・再送コスト | multipart・整合性管理 |

これらの対策は、
大規模な設計変更を伴わず、実装コストも低い一方で、
パイプライン全体の堅牢性を大きく向上させる。

本ドキュメントは、
今後の設計判断・改善検討・障害対応時の判断基準として使用する。
